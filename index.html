<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<script>
// Unregister any stale service workers
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(function(regs) {
    regs.forEach(function(r) { r.unregister(); });
  });
}
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>The Table</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%23060e07'/><text y='0.9em' font-size='320' text-anchor='middle' x='256' fill='%23c9a84c'>‚ô†</text></svg>">
<style>
/* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{
  width:100%;height:100%;overflow:hidden;
  background:#060e07;color:#f0e6c8;
  font-family:DM Sans,sans-serif;
  font-size:16px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

:root{
  --gold:#c9a84c;--gold2:#e8c96a;--gold-dim:#7a5820;
  --cream:#f0e6c8;--cream2:#d4c4a0;
  --green:#2ecc71;--red:#e74c3c;
  --felt-top:#1e6b2a;--felt-mid:#155220;--felt-bot:#0e3a18;
  --rail:#3d1f08;--rail2:#5a3010;
  --border:rgba(201,168,76,0.15);--border2:rgba(201,168,76,0.35);
  --muted:#6b8c6e;--bg:#060e07;--bg2:#0d1f10;--bg3:#111f13;
  --r:12px;--rs:8px;
  --display:'Playfair Display',serif;
  --body:'DM Sans',sans-serif;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);overflow:hidden}
.screen[hidden]{display:none!important}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px 16px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,rgba(30,107,42,0.08),transparent);
  flex-shrink:0;
}
.home-logo{font-family:var(--display);font-size:1.75rem;font-weight:700;color:var(--gold);letter-spacing:1px}
.home-plus{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold),#8a5c20);
  border:none;color:#000;font-size:1.7rem;line-height:1;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 16px rgba(201,168,76,0.35);
}
.home-body{flex:1;overflow-y:auto;padding-bottom:8px}
.home-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:60px 32px;min-height:60vh}
.home-empty-icon{width:96px;height:96px;border-radius:50%;background:rgba(201,168,76,0.06);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:2.4rem;margin-bottom:24px}
.home-empty-title{font-family:var(--display);font-size:1.7rem;font-weight:700;color:var(--cream);margin-bottom:10px}
.home-empty-sub{font-size:1rem;color:var(--muted);line-height:1.7;margin-bottom:32px;max-width:260px}
.home-cta{width:100%;max-width:300px;padding:16px;background:linear-gradient(135deg,var(--gold),#8a5c20);color:#000;border:none;border-radius:var(--r);font-size:1rem;font-weight:700;cursor:pointer}

.section-title{font-family:var(--display);font-size:1.2rem;font-weight:600;color:var(--cream);padding:18px 20px 10px}
.game-cards{padding:0 14px 16px;display:flex;flex-direction:column;gap:12px}
.game-card{display:flex;align-items:center;gap:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;cursor:pointer}
.game-card:active{opacity:0.8;border-color:var(--gold)}
.game-card-icon{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,#1a8a4a,#0f5a2e);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0}
.game-card-body{flex:1;min-width:0}
.game-card-name{font-size:1.05rem;font-weight:600;color:var(--cream);margin-bottom:5px}
.game-card-meta{font-size:0.82rem;color:var(--muted)}
.game-card-live{font-size:0.68rem;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;padding:4px 10px;border-radius:20px;background:rgba(46,204,113,0.15);color:var(--green);border:1px solid rgba(46,204,113,0.3);flex-shrink:0}
.continue-btn{margin:0 14px 20px;padding:15px;background:linear-gradient(135deg,#1a8a4a,#0f5a2e);color:#fff;border:none;border-radius:var(--r);font-size:1rem;font-weight:600;cursor:pointer;width:calc(100% - 28px)}

.home-tabs{flex-shrink:0;display:flex;border-top:1px solid var(--border);background:var(--bg);z-index:10}
.home-tab{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 14px;gap:4px;cursor:pointer;font-size:0.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);border:none;background:none}
.home-tab.active{color:var(--gold)}
.home-tab-icon{font-size:1.4rem;line-height:1}

/* leaderboard rows */
.lb-row{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin:0 14px 8px}
.lb-row:first-child{border-color:rgba(201,168,76,0.35);background:#132a14}
.lb-rank{width:30px;text-align:center;font-size:0.9rem;font-weight:700;color:var(--muted);flex-shrink:0}
.lb-av{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:0.78rem;font-weight:700;color:var(--cream);flex-shrink:0}
.lb-name{flex:1;font-size:1rem;font-weight:600;color:var(--cream)}
.lb-sub{font-size:0.78rem;color:var(--muted)}
.lb-net{font-size:1.1rem;font-weight:700}
.pos{color:var(--green)}.neg{color:var(--red)}.zero{color:var(--muted)}

/* contacts */
.contact-row{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--border)}
.contact-av{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:0.78rem;font-weight:700;color:var(--cream);flex-shrink:0}
.contact-name{flex:1;font-size:0.95rem;color:var(--cream)}
.contact-phone{font-size:0.78rem;color:var(--muted)}
.icon-btn{background:none;border:none;cursor:pointer;padding:6px;font-size:1rem;color:var(--muted)}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
.topbar{flex:0 0 auto;display:flex;align-items:center;height:52px;background:var(--bg);border-bottom:1px solid var(--border)}
.tb-back{display:flex;align-items:center;gap:4px;padding:0 16px;height:100%;cursor:pointer;color:var(--gold);font-size:0.9rem;font-weight:500;border-right:1px solid var(--border);flex-shrink:0;background:none;border-top:none;border-bottom:none;border-left:none}
.tb-title{flex:1;font-family:var(--display);font-size:1.05rem;font-weight:700;color:var(--gold);padding:0 14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tb-actions{display:flex;gap:5px;padding:0 8px;flex-shrink:0}
.tbtn{background:none;border:1px solid var(--border);color:var(--muted);padding:6px 12px;font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;cursor:pointer;border-radius:6px;white-space:nowrap}
.tbtn:active{border-color:var(--gold);color:var(--gold)}
.tbtn.red:active{border-color:var(--red);color:var(--red)}
.tbtn.gold{border-color:rgba(201,168,76,0.35);color:var(--gold)}
.tbtn.gold:active{background:rgba(201,168,76,0.1)}

.game-tabs{flex-shrink:0;display:flex;border-top:1px solid var(--border);background:var(--bg);z-index:10}
.game-tab{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 14px;gap:3px;cursor:pointer;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);border:none;background:none;white-space:nowrap}
.game-tab:active{color:var(--gold);background:rgba(201,168,76,0.04)}
.game-tab.red:active{color:var(--red)}
.game-tab-icon{font-size:1.3rem;line-height:1}

/* bank bar */
.bank-bar{flex:0 0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:46px;background:var(--bg);border-bottom:1px solid var(--border);cursor:pointer;gap:10px}
.bank-bar:active{background:rgba(201,168,76,0.03)}
.bank-left{display:flex;align-items:center;gap:10px;flex-shrink:0}
.bank-icon{width:28px;height:20px;border-radius:4px;background:linear-gradient(135deg,#b8860b,#8a6410);display:flex;align-items:center;justify-content:center;font-size:0.78rem}
.bank-label{font-size:0.95rem;font-weight:600;color:var(--cream)}
.bank-right{display:flex;align-items:center;gap:8px;min-width:0}
.bank-pill{font-size:0.82rem;color:var(--muted);white-space:nowrap}
.bank-pill.g{color:var(--green)}
.share-btn{flex-shrink:0;background:linear-gradient(135deg,var(--gold),#8a5c20);color:#000;border:none;padding:6px 12px;font-size:0.72rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;cursor:pointer;border-radius:6px}
.bank-caret{font-size:0.6rem;color:var(--muted);transition:transform 0.25s;flex-shrink:0}
.bank-bar.open .bank-caret{transform:rotate(180deg)}

.bank-panel{flex:0 0 auto;overflow:hidden;max-height:0;transition:max-height 0.3s ease;background:var(--bg)}
.bank-panel.open{max-height:240px}
.bank-grid{display:grid;grid-template-columns:1fr 1fr;margin:12px;background:var(--bg2);border:1px solid rgba(201,168,76,0.14);border-radius:var(--r);overflow:hidden}
.bank-cell{padding:12px 14px;display:flex;flex-direction:column;gap:4px;background:#132b16}
.bank-cell:nth-child(1){border-bottom:1px solid rgba(201,168,76,0.07);border-right:1px solid rgba(201,168,76,0.07)}
.bank-cell:nth-child(2){border-bottom:1px solid rgba(201,168,76,0.07)}
.bank-cell:nth-child(3){border-right:1px solid rgba(201,168,76,0.07)}
.bank-cell-lbl{font-size:0.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)}
.bank-cell-val{font-size:1.4rem;font-weight:700}
.bank-cell-sub{font-size:0.68rem;color:var(--muted)}

/* table area */
.table-area{flex:1;position:relative;overflow:hidden;min-height:0}
.table-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
#tableOuter{position:absolute;border-radius:36px;background:linear-gradient(135deg,var(--rail2),var(--rail));box-shadow:0 8px 40px rgba(0,0,0,0.7)}
#tableFelt{position:absolute;border-radius:28px;background:radial-gradient(ellipse at 50% 40%,var(--felt-top),var(--felt-mid) 55%,var(--felt-bot));display:flex;align-items:center;justify-content:center}
#tableCenter{text-align:center;z-index:1;padding:8px;pointer-events:none}
#tableName{font-family:var(--display);font-size:clamp(0.7rem,2vw,1rem);color:rgba(240,230,200,0.55);letter-spacing:2px;text-transform:uppercase}
#tableStats{font-size:clamp(0.6rem,1.5vw,0.75rem);color:rgba(201,168,76,0.45);margin-top:5px;letter-spacing:1px}
#seatsContainer{position:absolute;inset:0}

/* seats */
.seat{position:absolute;transform:translate(-50%,-50%);cursor:pointer;z-index:5;display:flex;flex-direction:column;align-items:center;gap:3px}
.seat-chip{width:clamp(36px,9vw,48px);height:clamp(36px,9vw,48px);border-radius:50%;border:2px solid rgba(201,168,76,0.25);background:#0d1a0f;display:flex;align-items:center;justify-content:center;transition:transform 0.15s}
.seat:active .seat-chip{transform:scale(0.88)}
.seat-chip.empty .seat-inner{font-size:clamp(1rem,2.5vw,1.2rem);color:rgba(201,168,76,0.3)}
.seat-chip.seated{border-color:var(--gold);border-width:2.5px;background:linear-gradient(135deg,#1a3a1a,#0d2010)}
.seat-chip.seated .seat-inner{font-size:clamp(0.72rem,2vw,0.88rem);font-weight:700;color:var(--cream)}
.seat-chip.cashed{border-color:rgba(46,204,113,0.5);background:linear-gradient(135deg,#0a2a1a,#061510)}
.seat-chip.cashed .seat-inner{font-size:clamp(0.72rem,2vw,0.88rem);font-weight:700;color:var(--green)}
.seat-chip.rsvp{border-color:rgba(201,168,76,0.4);background:rgba(201,168,76,0.06)}
.seat-label{font-size:clamp(0.75rem,2vw,0.9rem);font-weight:600;color:#fff;max-width:clamp(68px,16vw,96px);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;background:rgba(0,0,0,0.6);padding:2px 7px;border-radius:5px;text-shadow:0 1px 3px rgba(0,0,0,0.9)}
.seat-net{font-size:clamp(0.62rem,1.6vw,0.78rem);font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.8)}

/* side panel */
.side-panel{width:0;overflow:hidden;background:#09180a;border-left:1px solid var(--border);display:flex;flex-direction:column;transition:width 0.25s ease;flex-shrink:0}
.side-panel.open{width:min(300px,80vw)}
.panel-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.panel-title{font-family:var(--display);font-size:1.15rem;font-weight:700;color:var(--cream)}
.panel-close{background:none;border:none;color:var(--muted);font-size:1.3rem;cursor:pointer;padding:2px 6px;line-height:1}
.panel-body{flex:1;overflow-y:auto;padding:12px 14px}
.psec{font-size:0.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold-dim);margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid rgba(201,168,76,0.08)}
.psec:first-child{margin-top:0}

/* player summary */
.p-sum{display:flex;align-items:center;gap:12px;padding:8px 0 14px;border-bottom:1px solid var(--border);margin-bottom:6px}
.p-av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:0.88rem;font-weight:700;color:var(--cream);flex-shrink:0}
.p-info{flex:1;min-width:0}
.p-name{font-size:1rem;font-weight:600;color:var(--cream);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.p-meta{font-size:0.78rem;color:var(--muted);margin-top:3px}
.p-net{font-size:1.2rem;font-weight:700;white-space:nowrap}

/* transactions */
.tx-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.tx-badge{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.5px;padding:3px 7px;border-radius:4px;flex-shrink:0;white-space:nowrap;font-weight:600}
.tx-badge.bi{background:rgba(201,168,76,0.12);color:var(--gold)}
.tx-badge.rb{background:rgba(200,100,30,0.12);color:#ffaa60}
.tx-badge.co{background:rgba(46,204,113,0.12);color:var(--green)}
.tx-amt{background:transparent;border:none;border-bottom:1px solid rgba(201,168,76,0.2);color:var(--cream);font-size:0.95rem;width:72px;padding:2px 4px;outline:none;font-family:var(--body)}
.tx-amt:focus{border-bottom-color:var(--gold)}
.tx-time{font-size:0.72rem;color:var(--muted);flex:1}
.tx-del{background:none;border:none;color:rgba(231,76,60,0.35);cursor:pointer;font-size:1rem;padding:3px 2px;flex-shrink:0;line-height:1}
.tx-del:active{color:var(--red)}

/* add row */
.add-row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
.add-inp{flex:1;background:rgba(4,12,5,0.9);border:1px solid var(--border);color:var(--cream);padding:11px 10px;font-size:1rem;border-radius:var(--rs);outline:none;min-width:0;font-family:var(--body)}
.add-inp:focus{border-color:var(--gold)}
.add-btn{background:linear-gradient(135deg,var(--gold),#8a5c20);color:#000;border:none;padding:11px 14px;font-size:0.82rem;font-weight:700;cursor:pointer;border-radius:var(--rs);white-space:nowrap;flex-shrink:0}
.add-btn:active{opacity:0.8}
.add-btn.g{background:linear-gradient(135deg,#1a8a4a,#0f5a2e);color:#a0ffcc}
.add-btn.o{background:linear-gradient(135deg,#c06020,#8a4010);color:#ffaa60}

/* wa/share button */
.wa-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#25D366;color:#fff;border:none;padding:11px;border-radius:var(--rs);font-size:0.9rem;font-weight:700;cursor:pointer;text-decoration:none;width:100%}
.wa-btn:active{opacity:0.8}

/* remove btn */
.remove-btn{width:100%;padding:11px;background:rgba(231,76,60,0.1);color:var(--red);border:1px solid rgba(231,76,60,0.2);border-radius:var(--rs);font-size:0.9rem;font-weight:600;cursor:pointer}
.remove-btn:active{background:rgba(231,76,60,0.2)}

/* known player chips */
.known-chip{background:var(--bg2);border:1px solid var(--border);color:var(--cream2);padding:7px 13px;border-radius:20px;font-size:0.88rem;cursor:pointer}
.known-chip:active{border-color:var(--gold);color:var(--gold)}
.known-chip.seated{opacity:0.4;pointer-events:none}

/* ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:#0d1f10;border:1px solid var(--border2);border-radius:16px;padding:24px;width:100%;max-width:420px;max-height:88vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
.modal h2{font-family:var(--display);font-size:1.35rem;font-weight:700;color:var(--gold);margin-bottom:20px}
.field{margin-bottom:14px}
.field label{display:block;font-size:0.72rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;font-weight:600}
.field input,.field select,.field textarea{width:100%;background:rgba(4,12,5,0.9);border:1px solid var(--border);color:var(--cream);padding:11px 13px;font-size:1rem;border-radius:var(--rs);outline:none;font-family:var(--body)}
.field input:focus,.field select:focus{border-color:var(--gold)}
.field select{-webkit-appearance:none;appearance:none}
.modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
.btn-primary{background:linear-gradient(135deg,var(--gold),#8a5c20);color:#000;border:none;padding:12px 22px;font-size:0.92rem;font-weight:700;cursor:pointer;border-radius:var(--rs)}
.btn-primary:active{opacity:0.8}
.btn-cancel{background:none;border:1px solid var(--border);color:var(--muted);padding:12px 18px;font-size:0.92rem;cursor:pointer;border-radius:var(--rs)}
.btn-cancel:active{border-color:var(--gold);color:var(--gold)}

/* sheet (bottom slide) */
.sheet{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.75);align-items:flex-end;justify-content:center}
.sheet.show{display:flex}
.sheet-box{background:#0d1f10;border-top:1px solid var(--border2);width:100%;max-width:560px;max-height:90vh;display:flex;flex-direction:column;border-radius:20px 20px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,0.5)}
.sheet-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.sheet-hdr h2{font-family:var(--display);font-size:1.2rem;font-weight:700;color:var(--cream)}
.sheet-body{overflow-y:auto;flex:1;padding:14px 18px 28px}
.sheet-tabs{display:flex;gap:8px;padding:12px 18px 0;flex-shrink:0}
.sheet-tab{flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--rs);padding:9px;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);cursor:pointer;text-align:center}
.sheet-tab.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold)}

/* phone row */
.phone-row{display:flex;gap:8px;align-items:center}
.phone-flag{font-size:1rem;flex-shrink:0}
.phone-inp{flex:1;background:rgba(4,12,5,0.9);border:1px solid var(--border);color:var(--cream);padding:11px 12px;font-size:1rem;border-radius:var(--rs);outline:none;font-family:var(--body)}
.phone-inp:focus{border-color:var(--gold)}

/* live view */
#liveScreen{background:var(--bg);overflow-y:auto}
.lv-inner{max-width:560px;margin:0 auto;padding-bottom:40px}
.lv-hdr{text-align:center;padding:28px 18px 18px;border-bottom:1px solid var(--border)}
.lv-title{font-family:var(--display);font-size:clamp(1.5rem,5vw,2.2rem);font-weight:700;color:var(--gold);letter-spacing:1px}
.lv-sub{font-size:0.75rem;text-transform:uppercase;letter-spacing:3px;color:var(--muted);margin-top:5px}
.lv-live{display:inline-flex;align-items:center;gap:6px;font-size:0.72rem;text-transform:uppercase;letter-spacing:2px;color:var(--green);margin-top:8px}
.lv-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
.lv-bank{display:flex;border-bottom:1px solid var(--border)}
.lv-bk{flex:1;text-align:center;padding:10px 4px;border-right:1px solid var(--border)}
.lv-bk:last-child{border-right:none}
.lv-bk-l{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:4px}
.lv-bk-v{font-size:1rem;font-weight:700;color:var(--cream)}
.lv-bk-v.ok{color:var(--green)}.lv-bk-v.no{color:var(--red)}
.lv-rows{padding:14px}
.lv-row{display:flex;align-items:center;gap:10px;background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--border);border-radius:6px;padding:11px 13px;margin-bottom:8px}
.lv-row.win{border-left-color:var(--green)}.lv-row.lose{border-left-color:var(--red)}
.lv-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;color:var(--cream);flex-shrink:0}
.lv-nm{flex:1;font-size:0.95rem;color:var(--cream)}
.lv-pl{font-size:1rem;font-weight:700}

/* results view */
#resultsScreen{background:var(--bg);overflow-y:auto}
.res-hero{text-align:center;padding:40px 20px 28px;background:linear-gradient(160deg,#0a1f0c,var(--bg))}
.res-hero h1{font-family:var(--display);font-size:clamp(1.5rem,5vw,2.2rem);font-weight:700;color:var(--gold);letter-spacing:1px}
.res-sub{font-size:0.72rem;text-transform:uppercase;letter-spacing:4px;color:var(--muted);margin-top:8px}
.res-meta{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-top:18px}
.rm{text-align:center}.rm-v{font-size:1rem;font-weight:700;color:var(--cream)}.rm-l{font-size:0.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-top:3px}
.res-rows{max-width:460px;margin:0 auto;padding:18px}
.res-sec{font-size:0.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--gold-dim);margin-bottom:12px}
.res-row{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:6px}
.rr-rank{font-size:1rem;font-weight:700;width:24px;text-align:center;color:var(--muted);flex-shrink:0}
.rr-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;color:var(--cream);flex-shrink:0}
.rr-nm{flex:1;min-width:0}
.rr-n{font-size:0.95rem;color:var(--cream);font-weight:600}
.rr-d{font-size:0.72rem;color:var(--muted)}
.rr-pl{font-size:1rem;font-weight:700}
.res-footer{text-align:center;padding:20px 16px 40px;font-size:0.75rem;color:var(--muted);line-height:2}

/* settlements */
.settle-section{max-width:460px;margin:0 auto;padding:0 16px 16px}
.settle-hdr{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.settle-hdr-icon{font-size:1.4rem}
.settle-title{font-size:0.68rem;text-transform:uppercase;letter-spacing:3px;color:var(--gold-dim)}
.settle-clean{font-size:0.9rem;color:var(--green);padding:14px;text-align:center;background:rgba(46,204,113,0.06);border:1px solid rgba(46,204,113,0.2);border-radius:var(--rs)}
.settle-row{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;position:relative;overflow:hidden}
.settle-row::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--red),#8a1010)}
.settle-from{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:50px}
.settle-av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;flex-shrink:0}
.settle-from .settle-av{background:linear-gradient(135deg,rgba(231,76,60,0.3),rgba(139,0,0,0.4));color:#ff9a8b;border:1px solid rgba(231,76,60,0.3)}
.settle-to .settle-av{background:linear-gradient(135deg,rgba(46,204,113,0.2),rgba(0,100,50,0.4));color:#7fffb0;border:1px solid rgba(46,204,113,0.25)}
.settle-nm{font-size:0.68rem;color:var(--muted);text-align:center;max-width:52px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.settle-arrow{display:flex;flex-direction:column;align-items:center;flex:1;gap:5px}
.settle-arrow-line{font-size:1.2rem;color:var(--muted)}
.settle-amount{font-size:1.15rem;font-weight:700;color:var(--cream)}
.settle-to{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:50px}
.settle-wa{margin-left:auto;flex-shrink:0;background:rgba(37,211,102,0.15);border:1px solid rgba(37,211,102,0.3);color:#25D366;padding:7px 12px;border-radius:var(--rs);font-size:0.82rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;text-decoration:none}
.settle-wa:active{background:rgba(37,211,102,0.25)}
.settle-sheet-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.settle-sheet-row:last-child{border-bottom:none}
.settle-sheet-from{font-size:0.95rem;font-weight:700;color:var(--red);min-width:64px}
.settle-sheet-arrow{color:var(--muted);font-size:1rem;flex-shrink:0}
.settle-sheet-to{font-size:0.95rem;font-weight:700;color:var(--green);flex:1}
.settle-sheet-amt{font-size:1.05rem;font-weight:700;color:var(--cream)}
.settle-wa-sm{background:rgba(37,211,102,0.12);border:1px solid rgba(37,211,102,0.25);color:#25D366;padding:6px 11px;border-radius:var(--rs);font-size:0.78rem;font-weight:700;cursor:pointer;text-decoration:none;flex-shrink:0;display:flex;align-items:center;gap:3px}

/* toast */
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);background:#1a3a1a;color:var(--cream);padding:10px 20px;border-radius:24px;font-size:0.9rem;opacity:0;pointer-events:none;transition:all 0.25s;z-index:999;white-space:nowrap;border:1px solid rgba(201,168,76,0.2)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* wa toast */
#waToast{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:998;background:#0d1f10;border:1px solid rgba(37,211,102,0.4);border-radius:16px;padding:16px 18px;width:min(360px,92vw);box-shadow:0 8px 40px rgba(0,0,0,0.6)}
#waToast.show{display:block}
.wa-toast-hdr{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.wa-toast-label{font-size:0.72rem;text-transform:uppercase;letter-spacing:1.5px;color:rgba(37,211,102,0.8);flex:1}
.wa-toast-close{background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;line-height:1}
.wa-toast-msg{font-size:0.9rem;color:var(--cream2);line-height:1.6;background:rgba(0,0,0,0.3);border-radius:var(--rs);padding:11px 12px;margin-bottom:12px}
.wa-toast-btns{display:flex;gap:8px}
.wa-toast-send{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:#25D366;color:#fff;padding:11px;border-radius:var(--rs);font-size:0.9rem;font-weight:700;text-decoration:none;cursor:pointer}
.wa-toast-skip{background:none;border:1px solid rgba(201,168,76,0.15);color:var(--muted);padding:11px 16px;border-radius:var(--rs);font-size:0.9rem;cursor:pointer}

/* qr share */
.qr-wrap{display:flex;justify-content:center;margin-bottom:14px}
.qr-url{font-size:0.78rem;color:var(--cream2);word-break:break-all;line-height:1.5;background:rgba(4,12,5,0.9);border:1px solid var(--border);border-radius:var(--rs);padding:10px 12px;margin-bottom:12px}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050f06">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="The Table">
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen" class="screen">
  <div class="home-hdr">
    <div class="home-logo">‚ô† The Table</div>
    <button class="home-plus" id="homeAddBtn" onclick="openNewGame()">+</button>
  </div>
  <div class="home-body" id="homeBody"></div>
  <div class="home-tabs">
    <button class="home-tab active" id="tabGames" onclick="switchTab('games')"><span class="home-tab-icon">‚ô†</span>Games</button>
    <button class="home-tab" id="tabLeaderboard" onclick="switchTab('leaderboard')"><span class="home-tab-icon">üèÜ</span>All Time</button>
    <button class="home-tab" id="tabHistory" onclick="switchTab('history')"><span class="home-tab-icon">üìÖ</span>History</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen" hidden>
  <div class="topbar">
    <button class="tb-back" id="backBtn" onclick="renderHome()">‚Äπ Games</button>
    <div style="display:flex;flex-direction:column;flex:1">
      <div class="tb-title" id="topbarTitle">The Table</div>
      <div id="gameCodeBadge" style="display:none;font-size:0.88rem;color:var(--gold);letter-spacing:2.5px;font-weight:700;line-height:1;padding-left:12px"></div>
    </div>
    <button class="share-btn" id="shareBtn" onclick="openShare()" style="margin-right:10px">‚¨° Share</button>
  </div>
  <div class="bank-bar" id="bankBar" onclick="toggleBank()">
    <div class="bank-left">
      <div class="bank-icon">üí≥</div>
      <span class="bank-label">Bank Summary</span>
    </div>
    <div class="bank-right">
      <span class="bank-pill g" id="bbIn">$0 in</span>
      <span class="bank-pill" style="opacity:0.4">¬∑</span>
      <span class="bank-pill" id="bbBank">$0 bank</span>
      <span class="bank-caret">‚ñº</span>
    </div>
  </div>
  <div class="bank-panel" id="bankPanel">
    <div class="bank-grid">
      <div class="bank-cell"><div class="bank-cell-lbl">‚Üó Total Buy-ins</div><div class="bank-cell-val pos" id="bcIn">$0.00</div></div>
      <div class="bank-cell"><div class="bank-cell-lbl">‚Üò Cash-outs</div><div class="bank-cell-val neg" id="bcOut">$0.00</div></div>
      <div class="bank-cell"><div class="bank-cell-lbl">üí≥ In Bank</div><div class="bank-cell-val" id="bcBank">$0.00</div><div class="bank-cell-sub" id="bcBankSub"></div></div>
      <div class="bank-cell"><div class="bank-cell-lbl">‚ö° Status</div><div class="bank-cell-val" id="bcStatus">0 Active</div><div class="bank-cell-sub" id="bcStatusSub"></div></div>
    </div>
  </div>
  <div style="display:flex;flex:1;overflow:hidden;min-height:0">
    <div class="table-area" id="tableArea">
      <div class="table-wrap" id="tableWrap">
        <div id="tableOuter"></div>
        <div id="tableFelt"><div id="tableCenter"><div id="tableName"></div><div id="tableStats"></div></div></div>
        <div id="seatsContainer"></div>
      </div>
    </div>
    <div class="side-panel" id="sidePanel">
      <div class="panel-hdr">
        <span class="panel-title" id="panelTitle">Player</span>
        <button class="panel-close" id="panelCloseBtn" onclick="closePanel()">‚úï</button>
      </div>
      <div class="panel-body" id="panelBody"></div>
    </div>
  </div>
  <div class="game-tabs">
    <button class="game-tab" id="publishBtn" onclick="openPublish()"><span class="game-tab-icon">üì§</span>Publish</button>
    <button class="game-tab" id="lbInGameBtn" onclick="openLeaderboard()"><span class="game-tab-icon">üèÜ</span>Leaderboard</button>
    <button class="game-tab" id="settleBtn" onclick="openSettleUp()"><span class="game-tab-icon">üí∏</span>Settle Up</button>
    <button class="game-tab red" id="endGameBtn" onclick="endGame()"><span class="game-tab-icon">üèÅ</span>End Game</button>
  </div>
</div>

<!-- LIVE SCREEN -->
<div id="liveScreen" class="screen" hidden>
  <div class="lv-inner" id="liveInner"></div>
</div>

<!-- RESULTS SCREEN -->
<div id="resultsScreen" class="screen" hidden>
  <div id="resultsInner"></div>
</div>

<!-- NEW GAME OVERLAY -->
<div class="overlay" id="newGameOverlay">
  <div class="modal">
    <h2>New Game</h2>
    <div class="field">
      <label>Master Password</label>
      <input type="password" id="ngMasterPw" placeholder="Required to create a game" autocomplete="off">
      <div id="ngMasterPwError" style="font-size:0.82rem;color:var(--red);min-height:16px;margin-top:3px"></div>
    </div>
    <div class="field"><label>Game Name</label><input type="text" id="ngName" placeholder="e.g. Friday Night Poker" autocomplete="off"></div>
    <div class="field"><label>Stakes (optional)</label><input type="text" id="ngStakes" placeholder="e.g. $1/$2 NL Hold'em" autocomplete="off"></div>
    <div class="field"><label>Date &amp; Time</label><input type="datetime-local" id="ngDate"></div>
    <div class="field"><label>Location (optional)</label><input type="text" id="ngLocation" placeholder="e.g. Jay's place" autocomplete="off"></div>
    <div class="field"><label>Seats</label>
      <select id="ngSeats">
        <option value="6">6 Seats</option><option value="7">7 Seats</option><option value="8">8 Seats</option>
        <option value="9">9 Seats</option><option value="10" selected>10 Seats</option>
        <option value="11">11 Seats</option><option value="12">12 Seats</option>
      </select>
    </div>
    <div class="field">
      <label>Default Buy-in Amount</label>
      <input type="number" id="ngDefaultBuyin" placeholder="e.g. 25" value="25" min="1" inputmode="decimal" autocomplete="off">
      <div style="font-size:0.9rem;color:var(--muted);margin-top:4px">RSVP players will be seated with this amount when you start the game</div>
    </div>
    <div class="field">
      <label>Game Password (optional)</label>
      <input type="password" id="ngPassword" placeholder="Set a password to protect Start Game" autocomplete="new-password">
      <div style="font-size:0.9rem;color:var(--muted);margin-top:4px">You'll need to enter this to start the game from the lobby</div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="ngCancelBtn" onclick="closeNewGame()">Cancel</button>
      <button class="btn-primary" id="ngConfirmBtn" onclick="confirmNewGame()">Create Game</button>
    </div>
  </div>
</div>

<!-- PASSWORD PROMPT OVERLAY -->
<div class="overlay" id="pwOverlay">
  <div class="modal" style="max-width:340px">
    <h2>üîí Enter Password</h2>
    <div style="font-size:0.88rem;color:var(--muted);margin-bottom:14px;line-height:1.6">This game is password protected. Enter the password to start.</div>
    <div class="field"><input type="password" id="pwInput" placeholder="Game password" autocomplete="off"></div>
    <div id="pwError" style="font-size:0.85rem;color:var(--red);min-height:18px;margin-bottom:8px;text-align:center"></div>
    <div class="modal-actions">
      <button class="btn-cancel" id="pwCancelBtn" onclick="document.getElementById('pwOverlay').classList.remove('show')">Cancel</button>
      <button class="btn-primary" id="pwConfirmBtn" onclick="const e=(document.getElementById('pwInput').value||'').trim(),c=state.game&&state.game.password;if(e!==c){document.getElementById('pwError').textContent='Incorrect password';document.getElementById('pwInput').value='';document.getElementById('pwInput').focus();return;}document.getElementById('pwOverlay').classList.remove('show');const cb=window._pwCallback||openGame;window._pwCallback=null;cb()">Unlock &amp; Start</button>
    </div>
  </div>
</div>

<!-- PRE-GAME LOBBY OVERLAY -->
<div class="overlay" id="lobbyOverlay">
  <div class="modal" style="max-width:420px;padding:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <h2 style="margin-bottom:0">üÉè Pre-Game Lobby</h2>
      <button id="lobbyMinimiseBtn" style="background:none;border:1px solid var(--border);color:var(--muted);padding:5px 10px;border-radius:6px;font-size:0.85rem;cursor:pointer" onclick="document.getElementById('lobbyOverlay').classList.remove('show');renderHome();toast('Lobby saved ‚Äî RSVP list updates automatically')">Save &amp; Close</button>
    </div>

    <div id="lobbyGameInfo" style="background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2);border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:0.9rem;color:var(--cream2);line-height:1.7"></div>

    <!-- TWO ACTION BUTTONS SIDE BY SIDE -->
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button id="lobbyWaBtn"
        style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:#25D366;color:#fff;border:none;padding:11px 8px;border-radius:9px;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:DM Sans,sans-serif">
        üí¨ Send RSVP Invite
      </button>
      <button id="lobbyInstallWaBtn"
        style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;background:rgba(46,204,113,0.15);border:1px solid rgba(46,204,113,0.35);color:var(--green);padding:11px 8px;border-radius:9px;font-size:0.9rem;font-weight:700;cursor:pointer;font-family:DM Sans,sans-serif">
        üì≤ Send Install Link
      </button>
    </div>

    <!-- INSTALL LINK COPY ROW -->
    <div id="lobbyInstallRow" style="display:none;margin-bottom:10px;padding:8px 10px;background:rgba(46,204,113,0.04);border:1px solid rgba(46,204,113,0.2);border-radius:8px">
      <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--green);margin-bottom:5px">üì≤ Player Install Link (first-time players only)</div>
      <div style="display:flex;gap:6px;align-items:center">
        <div id="lobbyInstallUrl" style="flex:1;font-size:0.8rem;color:var(--cream2);word-break:break-all;line-height:1.4"></div>
        <button id="lobbyInstallCopyBtn" style="background:rgba(46,204,113,0.15);border:1px solid rgba(46,204,113,0.3);color:var(--green);padding:5px 8px;border-radius:6px;font-family:DM Sans,sans-serif;font-size:0.8rem;cursor:pointer;white-space:nowrap;flex-shrink:0">Copy</button>
      </div>
    </div>

    <!-- RSVP SEATS -->
    <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold-dim);margin-bottom:6px">Players who RSVP'd</div>
    <div id="lobbySeats" style="max-height:160px;overflow-y:auto;margin-bottom:12px"></div>

    <div style="display:flex;gap:8px">
      <button class="btn-cancel" style="flex:1" id="lobbyCancelBtn" onclick="if(confirm('Cancel this game? All RSVP seats will be lost.')){closeLobby();state.game=null;state.players={};saveState();stopSyncPolling();renderHome()}">Cancel Game</button>
      <button class="btn-primary" style="flex:2" id="lobbyStartBtn" onclick="const pw=state.game&&state.game.password;if(pw){window._pwCallback=doStartGame;document.getElementById('pwInput').value='';document.getElementById('pwError').textContent='';document.getElementById('pwOverlay').classList.add('show')}else{doStartGame()}">‚ñ∂ Start Game</button>
    </div>
  </div>
</div>

<!-- ASSIGN OVERLAY -->
<div class="overlay" id="assignOverlay">
  <div class="modal">
    <h2>Seat Player</h2>
    <div id="knownWrap" style="display:none;margin-bottom:14px">
      <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px">Quick Select</div>
      <div id="knownList" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>
    <div class="field"><label>Name</label><input type="text" id="assignName" placeholder="Enter name..." autocomplete="off"></div>
    <div class="field">
      <label>WhatsApp (optional)</label>
      <div class="phone-row"><span class="phone-flag">üá¶üá∫</span><input type="tel" class="phone-inp" id="assignPhone" placeholder="04xx xxx xxx"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="assignCancelBtn" onclick="closeAssign()">Cancel</button>
      <button class="btn-primary" id="assignConfirmBtn" onclick="confirmAssign()">Seat Player</button>
    </div>
  </div>
</div>


<!-- NOTIFICATION PERMISSION TOAST -->
<div id="notifBanner" style="display:none;position:fixed;bottom:70px;left:0;right:0;z-index:550;padding:0 14px">
  <div style="background:#09180a;border:1px solid rgba(201,168,76,0.4);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.8)">
    <div style="font-size:1.4rem">üîî</div>
    <div style="flex:1">
      <div style="font-size:0.82rem;font-weight:700;color:var(--cream);margin-bottom:2px">Enable Notifications</div>
      <div style="font-size:0.82rem;color:var(--muted)">Get notified for buy-ins, cashouts & settlements</div>
    </div>
    <button id="notifEnableBtn" style="background:var(--gold);color:#000;border:none;padding:8px 14px;border-radius:8px;font-family:DM Sans,sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer" onclick="document.getElementById('notifBanner').style.display='none';registerServiceWorker().then(()=>Notification.requestPermission()).then(p=>{if(p==='granted'&&cloudGameCode&&cloudMyName){subscribePush(cloudMyName,cloudGameCode);toast('Notifications enabled!')}})">Enable</button>
    <button id="notifDismissBtn" style="background:none;border:none;color:var(--muted);font-size:1rem;cursor:pointer;padding:4px" onclick="document.getElementById('notifBanner').style.display='none';localStorage.setItem('notifDismissed','1')">‚úï</button>
  </div>
</div>
<!-- LEADERBOARD SHEET -->
<div class="sheet" id="lbSheet">
  <div class="sheet-box">
    <div class="sheet-hdr"><h2>üèÜ Leaderboard</h2><button class="panel-close" id="lbCloseBtn" onclick="closeLbSheet()">‚úï</button></div>
    <div class="sheet-tabs">
      <button class="sheet-tab active" id="lbTabAll" onclick="switchLbTab('all')">All Time</button>
      <button class="sheet-tab" id="lbTabGame" onclick="switchLbTab('game')">This Game</button>
    </div>
    <div class="sheet-body" id="lbBody"></div>
  </div>
</div>

<!-- SHARE SHEET -->
<div class="sheet" id="shareSheet">
  <div class="sheet-box">
    <div class="sheet-hdr"><h2>‚¨° Share Live Table</h2><button class="panel-close" id="shareCloseBtn" onclick="closeShare()">‚úï</button></div>
    <div class="sheet-body">
      <p style="font-size:0.85rem;color:var(--muted);margin-bottom:14px;line-height:1.6">Players scan to watch live ‚Äî read only.</p>
      <div class="qr-wrap"><canvas id="shareQR" style="border-radius:4px;background:#fff;padding:6px"></canvas></div>
      <div id="shareUrlLabel" style="font-size:0.9rem;color:var(--green);margin-bottom:4px;text-align:center"></div>
      <div class="qr-url" id="shareUrl"></div>
      <button class="btn-primary" style="width:100%;margin-bottom:8px" id="nativeShareBtn" onclick="shareLink(document.getElementById('shareUrl').textContent, 'Join The Table: ' + document.getElementById('shareUrl').textContent)">üì§ Share Link</button>
      <button class="btn-cancel" style="width:100%;margin-bottom:8px" id="copyShareBtn" onclick="copyText(document.getElementById('shareUrl').textContent)">Copy Link</button>
      <button class="btn-cancel" style="width:100%" id="shareCloseBtn2" onclick="closeShare()">Close</button>
    </div>
  </div>
</div>

<!-- PUBLISH SHEET -->
<div class="sheet" id="publishSheet">
  <div class="sheet-box">
    <div class="sheet-hdr"><h2>‚ô† Publish Results</h2><button class="panel-close" id="publishCloseBtn" onclick="closePublish()">‚úï</button></div>
    <div class="sheet-body">
      <div id="publishPreview" style="background:rgba(4,12,5,0.85);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;font-size:0.9rem"></div>
      <button id="waGroupShareBtn" onclick="sharePublishResults()" style="display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);color:#fff;padding:13px;border-radius:10px;font-size:0.88rem;font-weight:700;border:none;cursor:pointer;width:100%;margin-bottom:10px">
        <span style="font-size:1.1rem">üì§</span> Share Results
      </button>
      <div style="display:flex;gap:7px;margin-bottom:10px">
        <button class="btn-primary" style="flex:1" id="copyPublishBtn" onclick="copyText(document.getElementById('publishUrl').value)">Copy Link</button>
        <button class="btn-primary" style="flex:1;background:linear-gradient(135deg,#1a8a4a,#0f5a2e)" id="previewPublishBtn" onclick="window.open(document.getElementById('publishUrl').value,'_blank')">Preview</button>
      </div>
      <div class="field"><label>Shareable Results Link</label><input type="text" id="publishUrl" readonly onclick="this.select()" style="font-size:0.9rem;color:var(--muted)"></div>
    </div>
  </div>
</div>

<!-- WA TOAST -->
<div id="waToast">
  <div class="wa-toast-hdr">
    <span style="font-size:1rem">üí¨</span>
    <span class="wa-toast-label">WhatsApp Notification</span>
    <button class="wa-toast-close" id="waToastClose" onclick="hideWaToast()">‚úï</button>
  </div>
  <div class="wa-toast-msg" id="waToastMsg"></div>
  <div class="wa-toast-btns">
    <a class="wa-toast-send" id="waToastSend" href="#" target="_blank">üì§ Send via WhatsApp</a>
    <button class="wa-toast-skip" id="waToastSkip" onclick="hideWaToast()">Skip</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SK = 'pokerState', STATS_K = 'pokerStats', HIST_K = 'pokerHistory', PHONE_K = 'pokerPhones';
const MASTER_PASSWORD = '7984';

let state = { game: null, players: {} };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUD / WORKER CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WORKER_URL    = 'https://the-table-worker.jeemit1.workers.dev';
const APP_URL       = (typeof location !== 'undefined') ? location.origin : 'https://the-table-three.vercel.app';

// Fetch with a timeout so slow/unreachable worker never hangs the UI
function fetchWithTimeout(url, opts = {}, ms = 5000) {
  const ctrl = new AbortController();
  const tid = setTimeout(() => ctrl.abort(), ms);
  return fetch(url, { ...opts, signal: ctrl.signal })
    .finally(() => clearTimeout(tid));
}
const VAPID_PUBLIC  = 'BOjy7FRAI9dZ4ijq0X30ERbwRqpdiSiwD-Sm2AsfZl_hwpXy0b2omZ94_Lqi9Eb3U0IIh26CUXyEvgmpjcd3GNU';

// Role: 'host' (created game) | 'player' (joined game) | null (no game)
let cloudRole      = localStorage.getItem('cloudRole')      || null;
let cloudGameCode  = localStorage.getItem('cloudGameCode')  || null;
let cloudMyName    = localStorage.getItem('cloudMyName')    || null;
let cloudGroupId   = localStorage.getItem('cloudGroupId')   || null;
  if (cloudGroupId) syncStatsFromCloud();  // permanent group ID
let cloudGroupName = localStorage.getItem('cloudGroupName') || null;
let pushSub        = null;  // current push subscription object
let isReadOnly     = false; // true when viewing as player (no editing)
let syncInterval   = null;  // polling interval for players

function setGroupData(groupId, groupName) {
  cloudGroupId   = groupId;
  cloudGroupName = groupName;
  if (groupId) {
    localStorage.setItem('cloudGroupId',   groupId);
    localStorage.setItem('cloudGroupName', groupName || '');
  } else {
    localStorage.removeItem('cloudGroupId');
    localStorage.removeItem('cloudGroupName');
  }
}

function setCloudRole(role, code, name) {
  cloudRole     = role;
  cloudGameCode = code;
  cloudMyName   = name;
  if (role) {
    localStorage.setItem('cloudRole',     role);
    localStorage.setItem('cloudGameCode', code || '');
    localStorage.setItem('cloudMyName',   name || '');
  } else {
    localStorage.removeItem('cloudRole');
    localStorage.removeItem('cloudGameCode');
    localStorage.removeItem('cloudMyName');
  }
}

// ‚îÄ‚îÄ Worker API calls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiCreateGame(gameName, stakes) {
  const r = await fetchWithTimeout(WORKER_URL + '/game/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ gameName, stakes, hostName: 'Host' }),
  });
  if (!r.ok) throw new Error('Failed to create game');
  return r.json();  // { code, gameName }
}

async function apiGetGame(code) {
  const r = await fetchWithTimeout(WORKER_URL + '/game/' + code);
  if (!r.ok) throw new Error('Game not found');
  return r.json();
}

async function apiSetState(code, stateData) {
  await fetchWithTimeout(WORKER_URL + '/game/' + code + '/state', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ state: stateData }),
  });
}

async function apiSubscribe(code, playerName, subscription) {
  const r = await fetchWithTimeout(WORKER_URL + '/game/' + code + '/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ playerName, subscription }),
  });
  return r.json();
}

async function apiNotify(code, title, body, target) {
  await fetchWithTimeout(WORKER_URL + '/game/' + code + '/notify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, body: body || '', target: target || 'all' }),
  }).catch(() => {}); // notifications are best-effort
}

async function apiListPlayers(code) {
  const r = await fetchWithTimeout(WORKER_URL + '/game/' + code + '/players');
  if (!r.ok) return { players: [] };
  return r.json();
}

// ‚îÄ‚îÄ Group API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiCreateGroup(groupName) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ groupName }),
  });
  if (!r.ok) throw new Error('Failed to create group');
  return r.json(); // { groupId, groupName }
}

async function apiGetGroup(groupId) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/' + groupId);
  if (!r.ok) throw new Error('Group not found');
  return r.json(); // { groupId, groupName, activeGameCode, subscribers }
}

async function apiGroupSubscribe(groupId, playerName, subscription) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ playerName, subscription }),
  });
  return r.json();
}

async function apiGroupSetGame(groupId, gameCode) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/game', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ gameCode }),
  }).catch(() => {});
}

async function apiGroupNotify(groupId, title, body, target) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/notify', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, body: body || '', target: target || 'all' }),
  }).catch(() => {});
}
// ‚îÄ‚îÄ Cloud Stats & History API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiGetGroupStats(groupId) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/stats');
  if (!r.ok) return {};
  return r.json();
}
async function apiSetGroupStats(groupId, stats) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/stats', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(stats),
  }).catch(() => {});
}
async function apiGetGroupHistory(groupId) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/history');
  if (!r.ok) return [];
  return r.json();
}
async function apiSetGroupHistory(groupId, history) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/history', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(history),
  }).catch(() => {});
}
async function apiGetGroupGames(groupId) {
  const r = await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/games');
  if (!r.ok) return [];
  return r.json();
}
async function apiGroupAddGame(groupId, gameCode) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/games/add', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ gameCode }),
  }).catch(() => {});
}
async function apiGroupEndGame(groupId, gameCode) {
  await fetchWithTimeout(WORKER_URL + '/group/' + groupId + '/games/end', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ gameCode }),
  }).catch(() => {});
}





// ‚îÄ‚îÄ Push subscription ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function subscribePush(playerName, gameCode) {
  return subscribePushToGroup(playerName, gameCode);
}

async function subscribePushToGroup(playerName, gameCode) {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return null;
  try {
    // Use getRegistration instead of .ready ‚Äî blob SW doesn't resolve .ready on iOS
    let reg = await navigator.serviceWorker.getRegistration();
    if (!reg) {
      reg = await registerServiceWorker();
      if (reg) await new Promise(r => setTimeout(r, 1000));
      reg = await navigator.serviceWorker.getRegistration();
    }
    if (!reg) return null;
    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC),
      });
    }
    pushSub = sub;
    const subJSON = sub.toJSON();
    // Register with current game
    if (gameCode && gameCode !== 'LOCAL') {
      await apiSubscribe(gameCode, playerName, subJSON).catch(() => {});
    }
    // Register with group (persists across all future games)
    if (cloudGroupId) {
      await apiGroupSubscribe(cloudGroupId, playerName, subJSON).catch(() => {});
    }
    return sub;
  } catch(e) {
    console.warn('Push subscription failed:', e);
    return null;
  }
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64  = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const raw     = window.atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

// ‚îÄ‚îÄ Service Worker registration + inline SW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return Promise.resolve(null);
  // sw.js is a real file on Vercel ‚Äî skip registration on other origins (e.g. previews)
  const isVercel = location.hostname.endsWith('vercel.app') || location.hostname.endsWith('the-table.app');
  const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!isVercel && !isLocalhost) return Promise.resolve(null);
  return navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(reg => { console.log('SW registered'); return reg; })
    .catch(e  => { console.warn('SW failed:', e); return null; });
}

// ‚îÄ‚îÄ Sync: host pushes state up, players poll down ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastSyncHash = '';
let lastEtag = '';

async function syncToCloud() {
  if (cloudRole !== 'host' || !cloudGameCode || !state.game) return;
  const stateStr = JSON.stringify(state);
  if (stateStr === lastSyncHash) return;
  lastSyncHash = stateStr;
  try { await apiSetState(cloudGameCode, state); } catch(e) {}
}

async function syncFromCloud() {
  if (cloudRole !== 'player' || !cloudGameCode) return;
  try {
    const res = await fetchWithTimeout(WORKER_URL + '/game/' + cloudGameCode + '/poll', {
      headers: lastEtag ? { 'If-None-Match': lastEtag } : {},
    });
    if (res.status === 304) return; // no change
    if (res.status === 404) {
      // Game deleted ‚Äî treat same as ended
      handleGameEndedForPlayer('The game has ended.');
      return;
    }
    if (!res.ok) return;
    const data = await res.json();
    if (data.etag) lastEtag = data.etag;
    if (data.state) {
      // Check if host has ended the game
      if (data.state.game && data.state.game.ended) {
        handleGameEndedForPlayer(
          (data.state.game.name || 'The game') + ' has ended. Thanks for playing!'
        );
        return;
      }
      state = data.state;
      localStorage.setItem(SK, JSON.stringify(state));
      const gs = document.getElementById('gameScreen');
      if (gs && !gs.hidden) {
        renderTable();
        updateBankBar();
        if (isReadOnly) applyReadOnlyMode();
      }
    }
  } catch(e) {}
}

// Called on player device when the host ends the game.
// Clears the game session but keeps groupId + name so they get notified next game.
function handleGameEndedForPlayer(msg) {
  stopSyncPolling();
  // Keep cloudGroupId and cloudMyName ‚Äî needed for next game notifications
  const savedGroupId   = cloudGroupId;
  const savedGroupName = cloudGroupName;
  const savedMyName    = cloudMyName;
  // Clear game-specific session only
  cloudRole     = null;
  cloudGameCode = null;
  localStorage.removeItem('cloudRole');
  localStorage.removeItem('cloudGameCode');
  // Clear local game state
  state.game    = null;
  state.players = {};
  localStorage.setItem(SK, JSON.stringify(state));
  // Restore group + name (setCloudRole wipes them so we do it manually)
  cloudGroupId   = savedGroupId;
  cloudGroupName = savedGroupName;
  cloudMyName    = savedMyName;
  if (savedGroupId) localStorage.setItem('cloudGroupId', savedGroupId);
  if (savedGroupName) localStorage.setItem('cloudGroupName', savedGroupName);
  if (savedMyName) localStorage.setItem('cloudMyName', savedMyName);

  // Show game-over screen on whatever screen they're on
  showScreen('liveScreen');
  document.getElementById('liveInner').innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;
                min-height:100vh;padding:32px;text-align:center">
      <div style="font-size:3rem;margin-bottom:20px">üèÅ</div>
      <div style="font-size:1.2rem;font-weight:700;color:var(--cream);margin-bottom:10px">Game Over</div>
      <div style="font-size:0.82rem;color:var(--muted);margin-bottom:8px;line-height:1.6">${esc(msg)}</div>
      ${savedGroupId
        ? `<div style="font-size:0.88rem;color:var(--green);margin-bottom:28px">
             üîî You'll be notified when the next game is scheduled
           </div>`
        : `<div style="margin-bottom:28px"></div>`
      }
      <button onclick="currentTab='leaderboard'; renderHome();" style="padding:13px 32px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);
        color:#fff;border:none;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.88rem;
        font-weight:700;cursor:pointer">
        üèÜ See Leaderboard
      </button>
    </div>`;
}

function startSyncPolling() {
  if (syncInterval) clearInterval(syncInterval);
  lastEtag = '';
  if (cloudRole === 'host') {
    syncInterval = setInterval(syncToCloud, 1000);
  } else if (cloudRole === 'player') {
    syncInterval = setInterval(syncFromCloud, 800); // fast poll ~1s round-trip
  }
}

function stopSyncPolling() {
  if (syncInterval) { clearInterval(syncInterval); syncInterval = null; }
}

// ‚îÄ‚îÄ Notification helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function notifyAll(title, body) {
  if (cloudRole !== 'host') return;
  try {
    if (cloudGroupId) await apiGroupNotify(cloudGroupId, title, body, 'all');
    else if (cloudGameCode) await apiNotify(cloudGameCode, title, body, 'all');
  } catch(e) { /* notifications are best-effort */ }
}

async function notifyPlayer(playerName, title, body) {
  if (cloudRole !== 'host') return;
  try {
    if (cloudGroupId) await apiGroupNotify(cloudGroupId, title, body, playerName);
    else if (cloudGameCode) await apiNotify(cloudGameCode, title, body, playerName);
  } catch(e) { /* notifications are best-effort */ }
}

// ‚îÄ‚îÄ Show notification permission banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function maybeShowNotifBanner() {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'granted') return;
  if (localStorage.getItem('notifDismissed')) return;
  setTimeout(() => {
    const banner = document.getElementById('notifBanner');
    if (banner) banner.style.display = 'block';
  }, 2000);
}

function hardReset() {
  if (!confirm('Reset everything? This clears all local data.')) return;
  localStorage.clear();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
  }
  location.reload(true);
}

function loadState() {
  try { const s = localStorage.getItem(SK); if (s) state = JSON.parse(s); } catch(e) {}
}
function saveState() {
  localStorage.setItem(SK, JSON.stringify(state));
}
function getStats() {
  try { return JSON.parse(localStorage.getItem(STATS_K) || '{}'); } catch(e) { return {}; }
}
function saveStats(s) {
  localStorage.setItem(STATS_K, JSON.stringify(s));
  // Also push to cloud if we have a group
  if (cloudGroupId) apiSetGroupStats(cloudGroupId, s).catch(() => {});
}
function getHistory() {
  try { return JSON.parse(localStorage.getItem(HIST_K) || '[]'); } catch(e) { return []; }
}
function addHistory(name) {
  const h = getHistory().filter(n => n.toLowerCase() !== name.toLowerCase());
  localStorage.setItem(HIST_K, JSON.stringify([name, ...h].slice(0, 50)));
}
function getPhones() {
  try { return JSON.parse(localStorage.getItem(PHONE_K) || '{}'); } catch(e) { return {}; }
}
function savePhones(p) { localStorage.setItem(PHONE_K, JSON.stringify(p)); }
function getPhone(name) {
  return (getPhones()[name.toLowerCase()] || {}).phone || '';
}
function setPhone(name, raw) {
  if (!name.trim()) return;
  const pb = getPhones(), key = name.trim().toLowerCase();
  if (!pb[key]) pb[key] = { name: name.trim() };
  let p = raw.replace(/\D/g, '');
  if (p.startsWith('0')) p = '61' + p.slice(1);
  if (p) pb[key].phone = p;
  savePhones(pb);
}
function allContacts() {
  const pb = getPhones(), stats = getStats(), hist = getHistory();
  const seen = {};
  Object.values(pb).forEach(c => { seen[c.name.toLowerCase()] = { name: c.name, phone: c.phone || '' }; });
  Object.values(stats).forEach(s => { if (!seen[s.name.toLowerCase()]) seen[s.name.toLowerCase()] = { name: s.name, phone: '' }; });
  hist.forEach(n => { if (!seen[n.toLowerCase()]) seen[n.toLowerCase()] = { name: n, phone: '' }; });
  return Object.values(seen).sort((a, b) => a.name.localeCompare(b.name));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function inits(n) { return (n || '').split(' ').map(w => w[0] || '').join('').slice(0, 2).toUpperCase() || '?'; }
function fmt(n) { return '$' + (n || 0).toFixed(2); }
function fmtNet(n) { return n > 0 ? '+$' + n.toFixed(2) : n < 0 ? '-$' + Math.abs(n).toFixed(2) : '$0.00'; }
function nc(n) { return n > 0 ? 'pos' : n < 0 ? 'neg' : 'zero'; }
function pBuyin(p) { return (p.transactions || []).filter(t => t.type !== 'cashout').reduce((a, t) => a + t.amount, 0); }
function pCash(p) { return (p.transactions || []).filter(t => t.type === 'cashout').reduce((a, t) => a + t.amount, 0); }
function pNet(p) { return pCash(p) - pBuyin(p); }
function pad(n) { return String(n).padStart(2, '0'); }

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

function copyText(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
  toast('Copied! ‚ô†');
}
function fallbackCopy(t) {
  const el = document.createElement('textarea');
  el.value = t; document.body.appendChild(el); el.select();
  document.execCommand('copy'); document.body.removeChild(el);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  ['homeScreen','gameScreen','liveScreen','resultsScreen'].forEach(s => {
    document.getElementById(s).hidden = (s !== id);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOME SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab = 'games';


// Sync stats & history from cloud into localStorage (so all devices stay current)
async function syncStatsFromCloud() {
  if (!cloudGroupId) return;
  try {
    const [cloudStats, cloudHistory] = await Promise.all([
      apiGetGroupStats(cloudGroupId),
      apiGetGroupHistory(cloudGroupId),
    ]);
    if (cloudStats && Object.keys(cloudStats).length > 0) {
      localStorage.setItem(STATS_K, JSON.stringify(cloudStats));
    }
    if (cloudHistory && cloudHistory.length > 0) {
      localStorage.setItem('pokerGameHistory', JSON.stringify(cloudHistory));
    }
  } catch(e) {
    console.warn('Could not sync stats from cloud:', e);
  }
}


// Fetch all active/scheduled games from cloud for this group
async function syncCloudGames() {
  if (!cloudGroupId) return [];
  try {
    return await apiGetGroupGames(cloudGroupId);
  } catch(e) {
    return [];
  }
}

function renderHome() {
  showScreen('homeScreen');
  renderTab();
}

function switchTab(tab) {
  currentTab = tab;
  ['games','leaderboard','history'].forEach(t => {
    const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
    if (btn) btn.classList.toggle('active', t === tab);
  });
  // Pull fresh stats from cloud before rendering leaderboard/history
  if (tab !== 'games' && cloudGroupId) {
    syncStatsFromCloud().then(() => renderTab());
  } else {
    renderTab();
  }
}

function renderTab() {
  const body = document.getElementById('homeBody');
  if (currentTab === 'games') renderGamesTab(body);
  else if (currentTab === 'leaderboard') renderLeaderboardTab(body);
  else renderHistoryTab(body);
}

function renderGamesTab(body) {
  // If currently in a game, show game view (existing behaviour)
  if (state.game) {
    _renderGamesTabWithGame(body);
    return;
  }

  // Show loading state instantly, then populate with cloud games
  const stats   = getStats();
  const hist    = getGameHistory();
  const playerCount = Object.keys(stats).length;
  const totalGames  = hist.length;

  const notifGranted = 'Notification' in window && Notification.permission === 'granted';

  body.innerHTML =
    '<div style="padding:20px 16px 0">' +
    // Stats row
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">' +
      '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">' +
        '<div style="font-size:1.6rem;font-weight:700;color:var(--gold)">' + playerCount + '</div>' +
        '<div style="font-size:0.8rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-top:3px">Players Tracked</div>' +
      '</div>' +
      '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">' +
        '<div style="font-size:1.6rem;font-weight:700;color:var(--gold)">' + totalGames + '</div>' +
        '<div style="font-size:0.8rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-top:3px">Games Played</div>' +
      '</div>' +
    '</div>' +
    // Notification banner
    (cloudGroupId && !notifGranted ?
      ('<div id="homeNotifBanner" style="width:100%;margin-bottom:14px;padding:13px 16px;background:rgba(201,168,76,0.07);border:1px solid rgba(201,168,76,0.3);border-radius:12px;' +
       'color:var(--gold);font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px">' +
       '<span>üîî</span><span>' +
       (('Notification' in window && Notification.permission === 'denied')
         ? '‚ö†Ô∏è Notifications blocked ‚Äî tap for instructions'
         : 'Enable Notifications') +
       '</span></div>') : '') +
    // Scheduled games section
    '<div id="cloudGamesList"><div style="padding:20px;text-align:center;color:var(--muted);font-size:0.88rem">Loading games‚Ä¶</div></div>' +
    // New game button
    '<button class="home-cta" id="firstGameBtn" style="width:100%;margin-bottom:20px;padding:14px 20px;font-size:0.9rem">+ Schedule New Game</button>' +
    '</div>';

  document.getElementById('firstGameBtn').addEventListener('click', openNewGame);

  // Wire notification banner
  const notifBanner = document.getElementById('homeNotifBanner');
  if (notifBanner) {
    notifBanner.addEventListener('click', async () => {
      const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      if ('Notification' in window && Notification.permission === 'denied') {
        toast('Go to iPhone Settings ‚Üí The Table ‚Üí Notifications ‚Üí Allow');
        return;
      }
      if (!isStandalone) { toast('Open from your Home Screen icon first'); return; }
      try {
        await registerServiceWorker();
        const perm = await Notification.requestPermission();
        if (perm === 'granted') {
          notifBanner.style.display = 'none';
          toast('‚úì Notifications enabled!');
          if (cloudGroupId && cloudMyName) subscribePushToGroup(cloudMyName, null).catch(() => {});
        }
      } catch(e) {}
    });
  }

  // Load cloud games async
  syncCloudGames().then(cloudGames => {
    const container = document.getElementById('cloudGamesList');
    if (!container) return;

    if (!cloudGames || cloudGames.length === 0) {
      container.innerHTML =
        '<div style="background:linear-gradient(135deg,#0d2010,#132a14);border:1px solid rgba(201,168,76,0.15);border-radius:14px;padding:28px 20px;text-align:center;margin-bottom:14px">' +
          '<div style="font-size:2.2rem;margin-bottom:10px">‚ô†</div>' +
          '<div style="font-family:var(--display);font-size:1.1rem;font-weight:700;color:var(--cream);margin-bottom:6px">The Table</div>' +
          '<div style="font-size:0.88rem;color:var(--muted);line-height:1.6">No games scheduled yet.<br>Tap below to create your first game.</div>' +
        '</div>';
      return;
    }

    // Sort: active/lobby first, then by date
    const active  = cloudGames.filter(g => !g.ended).sort((a, b) => (a.gameDate || 0) - (b.gameDate || 0));
    const ended   = cloudGames.filter(g => g.ended);

    let html = '';

    if (active.length > 0) {
      html += '<div style="font-family:var(--display);font-size:1rem;font-weight:600;color:var(--cream);padding:4px 2px 10px">Scheduled Games</div>';
      active.forEach(g => {
        const dateStr = g.gameDate
          ? new Date(g.gameDate).toLocaleDateString(undefined, { weekday:'short', day:'numeric', month:'short' }) +
            ' ¬∑ ' + new Date(g.gameDate).toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit' })
          : 'Date TBC';
        const isLobby = g.lobbyActive && !g.ended;
        html +=
          '<div class="game-card" data-code="' + g.code + '" style="margin-bottom:10px;position:relative">' +
            '<div class="game-card-icon">üÉè</div>' +
            '<div class="game-card-body">' +
              '<div class="game-card-name">' + esc(g.name) + '</div>' +
              '<div class="game-card-meta">' + esc(dateStr) +
                (g.stakes ? ' ¬∑ ' + esc(g.stakes) : '') +
                (g.location ? ' ¬∑ ' + esc(g.location) : '') +
              '</div>' +
            '</div>' +
            (isLobby
              ? '<span class="game-card-live">OPEN</span>'
              : '<span style="font-size:0.65rem;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;padding:4px 10px;border-radius:20px;background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.25);flex-shrink:0">LOBBY</span>') +
          '</div>';
      });
    }

    if (ended.length > 0) {
      html += '<div style="font-family:var(--display);font-size:0.9rem;font-weight:600;color:var(--muted);padding:14px 2px 8px">Completed</div>';
      ended.slice(0, 3).forEach(g => {
        const dateStr = g.gameDate
          ? new Date(g.gameDate).toLocaleDateString(undefined, { day:'numeric', month:'short' })
          : '';
        html +=
          '<div class="game-card" data-code="' + g.code + '" style="margin-bottom:8px;opacity:0.7">' +
            '<div class="game-card-icon" style="background:linear-gradient(135deg,#1a1a2a,#0d0d1a)">üèÅ</div>' +
            '<div class="game-card-body">' +
              '<div class="game-card-name">' + esc(g.name) + '</div>' +
              '<div class="game-card-meta">' + esc(dateStr) +
                (g.stakes ? ' ¬∑ ' + esc(g.stakes) : '') +
              '</div>' +
            '</div>' +
            '<span style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">ENDED</span>' +
          '</div>';
      });
    }

    container.innerHTML = '<div style="margin-bottom:14px">' + html + '</div>';

    // Wire up card clicks
    container.querySelectorAll('.game-card[data-code]').forEach(card => {
      card.addEventListener('click', async () => {
        const code = card.dataset.code;
        const game = cloudGames.find(g => g.code === code);
        if (!game) return;
        // Load full game state from cloud
        try {
          const data = await apiGetGame(code);
          if (data && data.state) {
            state = data.state;
            saveState();
            setCloudRole('host', code, 'Host');
            if (game.lobbyActive && !game.ended) {
              const inviteLink = buildGroupLink('rsvp');
              openLobby(game.name, game.stakes, game.gameDate, game.location, game.seats || 9, inviteLink, code);
            } else if (!game.ended) {
              openGameWithPasswordCheck();
            } else {
              // Show ended game results
              showScreen('resultsScreen');
              renderResults();
            }
          }
        } catch(e) {
          toast('Could not load game ‚Äî check connection');
        }
      });
    });
  });
}


function renderLeaderboardTab(body) {
  const stats = getStats();
  // Merge current game into display
  const merged = {};
  Object.values(stats).forEach(s => { merged[s.name.toLowerCase()] = { name: s.name, games: s.games, net: s.net }; });
  if (state.game) {
    Object.values(state.players).filter(p => p && p.name && pBuyin(p) > 0).forEach(p => {
      const k = p.name.toLowerCase();
      if (!merged[k]) merged[k] = { name: p.name, games: 0, net: 0 };
      merged[k].games++;
      merged[k].net += pNet(p);
    });
  }
  const players = Object.values(merged).sort((a, b) => b.net - a.net);
  if (!players.length) {
    body.innerHTML = '<div class="home-empty"><div class="home-empty-icon">üèÜ</div><div class="home-empty-title">No history yet</div><div class="home-empty-sub">Complete a game to see all-time standings</div></div>';
    return;
  }
  body.innerHTML = '<div class="section-title">All Time Standings</div><div style="padding-bottom:80px">' +
    players.map((p, i) => `
      <div class="lb-row">
        <div class="lb-rank">${i === 0 ? 'üèÜ' : '#' + (i + 1)}</div>
        <div class="lb-av">${esc(inits(p.name))}</div>
        <div class="lb-info"><div class="lb-name">${esc(p.name)}</div><div class="lb-sub">${p.games} game${p.games !== 1 ? 's' : ''}</div></div>
        <div class="lb-net ${nc(p.net)}">${fmtNet(p.net)}</div>
      </div>`).join('') + '</div>';
}

function renderHistoryTab(body) {
  // Each saved game entry: { date, name, players: [{name, net}] }
  const hist = getGameHistory();
  if (!hist.length) {
    body.innerHTML = '<div class="home-empty"><div class="home-empty-icon">üìÖ</div><div class="home-empty-title">No history yet</div><div class="home-empty-sub">Completed games will appear here</div></div>';
    return;
  }
  body.innerHTML = '<div class="section-title">Friday Night History</div><div style="padding-bottom:80px">' +
    hist.slice().reverse().map(g => {
      const dateStr = g.date ? new Date(g.date).toLocaleDateString(undefined, { weekday:'short', day:'numeric', month:'short', year:'numeric' }) : 'Unknown date';
      const sorted = (g.players || []).slice().sort((a, b) => b.net - a.net);
      return `<div style="margin:0 16px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden">
        <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div style="font-size:0.82rem;font-weight:700;color:var(--gold)">${esc(g.name || 'Poker Night')}</div>
          <div style="font-size:0.82rem;color:var(--muted)">${dateStr}</div>
        </div>
        ${sorted.map((p, i) => `
          <div style="display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid rgba(201,168,76,0.06)">
            <div style="width:20px;text-align:center;font-size:0.88rem;color:var(--muted)">${i === 0 ? 'üèÜ' : '#'+(i+1)}</div>
            <div style="flex:1;font-size:0.9rem;color:var(--cream)">${esc(p.name)}</div>
            <div style="font-size:0.9rem;font-weight:700;color:${p.net >= 0 ? 'var(--green)' : 'var(--red)'}">${p.net >= 0 ? '+' : ''}$${Math.abs(p.net).toFixed(2)}</div>
          </div>`).join('')}
      </div>`;
    }).join('') + '</div>';
}

function getGameHistory() {
  try { return JSON.parse(localStorage.getItem('pokerGameHistory') || '[]'); } catch(e) { return []; }
}
function saveGameHistory(h) {
  localStorage.setItem('pokerGameHistory', JSON.stringify(h));
  // Also push to cloud if we have a group
  if (cloudGroupId) apiSetGroupHistory(cloudGroupId, h).catch(() => {});
}

function recordGameHistory(gameId) {
  if (!state.game) return;
  const players = Object.values(state.players)
    .filter(p => p && p.name && pBuyin(p) > 0)
    .map(p => ({ name: p.name, net: pNet(p) }))
    .sort((a, b) => b.net - a.net);
  if (!players.length) return;
  const hist = getGameHistory();
  // Remove any existing entry for this gameId before adding (idempotent)
  const filtered = gameId ? hist.filter(h => h.gameId !== gameId) : hist;
  const entry = {
    gameId,
    date: state.game.gameDate || state.game.startedAt || Date.now(),
    name: state.game.name || 'Poker Night',
    players
  };
  filtered.push(entry);
  saveGameHistory(filtered.slice(-52)); // keep last 52 games (1 year of weekly games)
}

// ‚îÄ‚îÄ Auto-schedule: notify group every Wednesday for Friday game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAutoSchedule() {
  if (!cloudGroupId || cloudRole !== 'host') return;
  const SCHED_KEY = 'lastScheduleNotif';
  const last = parseInt(localStorage.getItem(SCHED_KEY) || '0');
  const now = new Date();
  const weekStart = new Date(now);
  weekStart.setHours(0, 0, 0, 0);
  weekStart.setDate(now.getDate() - now.getDay()); // Sunday of this week

  // Only run on Wednesday (day 3), and only once per week
  if (now.getDay() !== 3) return; // not Wednesday
  if (last >= weekStart.getTime()) return; // already notified this week

  // Find next Friday
  const friday = new Date(now);
  friday.setDate(now.getDate() + (5 - now.getDay() + 7) % 7 || 7);
  friday.setHours(19, 0, 0, 0);
  const dateStr = friday.toLocaleDateString(undefined, { weekday: 'long', day: 'numeric', month: 'long' });

  localStorage.setItem(SCHED_KEY, weekStart.getTime().toString());

  // Notify all group subscribers
  apiGroupNotify(
    cloudGroupId,
    'üÉè Friday Night Poker ‚Äî Save the Date!',
    'Game on ' + dateStr + ' at 7pm. Tap to RSVP when the invite goes out.',
    'all'
  ).catch(() => {});
  toast('üìÖ Wednesday reminder sent to all players!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openNewGame() {
  const d = new Date(); d.setHours(19, 0, 0, 0);
  document.getElementById('ngDate').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T19:00`;
  document.getElementById('ngMasterPw').value = '';
  document.getElementById('ngMasterPwError').textContent = '';
  document.getElementById('ngName').value = '';
  document.getElementById('ngStakes').value = '';
  document.getElementById('ngLocation').value = '';
  document.getElementById('ngSeats').value = '10';
  document.getElementById('ngDefaultBuyin').value = '25';
  document.getElementById('ngPassword').value = '';
  document.getElementById('newGameOverlay').classList.add('show');
  setTimeout(() => document.getElementById('ngMasterPw').focus(), 100);
}
function closeNewGame() {
  document.getElementById('newGameOverlay').classList.remove('show');
}
async function confirmNewGame() {
  // Master password gate
  const masterPw = (document.getElementById('ngMasterPw').value || '').trim();
  if (masterPw !== MASTER_PASSWORD) {
    document.getElementById('ngMasterPwError').textContent = 'Incorrect password';
    document.getElementById('ngMasterPw').focus();
    return;
  }
  document.getElementById('ngMasterPwError').textContent = '';

  const name        = (document.getElementById('ngName').value || '').trim() || 'Poker Night';
  const stakes      = (document.getElementById('ngStakes').value || '').trim();
  const seats       = parseInt(document.getElementById('ngSeats').value) || 10;
  const gameDate    = document.getElementById('ngDate').value;
  const location    = (document.getElementById('ngLocation').value || '').trim();
  const defaultBuyin = parseFloat(document.getElementById('ngDefaultBuyin').value) || 25;
  const password    = (document.getElementById('ngPassword').value || '').trim();
  if (state.game && !confirm('Start a new game? Current game will be ended.')) return;
  if (state.game) { try { recordStats(); } catch(e) {} stopSyncPolling(); }

  const btn = document.getElementById('ngConfirmBtn');
  btn.textContent = 'Creating...'; btn.disabled = true;

  try {
  // Create game in cloud
  let code = null;
  try {
    const data = await apiCreateGame(name, stakes);
    code = data.code;
  } catch(e) {
    code = 'LOCAL';
    toast('Offline ‚Äî game code unavailable');
  }

  state.game = { name, stakes, seats, startedAt: Date.now(), gameDate, location, code, defaultBuyin, password: password || null };
  state.players = {};
  state.game.lobbyActive = true; // flag so we can restore the lobby on reload
  saveState();
  setCloudRole('host', code, 'Host');

  // Push initial state to cloud
  if (code !== 'LOCAL') {
    await apiSetState(code, state).catch(() => {});

    // Create or reuse group ‚Äî group carries subscribers across games
    if (!cloudGroupId) {
      // Try twice ‚Äî first attempt sometimes fails on a cold Cloudflare KV write
      for (let attempt = 1; attempt <= 2; attempt++) {
        try {
          const grp = await apiCreateGroup(name);
          if (grp && grp.groupId) { setGroupData(grp.groupId, grp.groupName); break; }
        } catch(e) {
          if (attempt === 2) toast('‚ö†Ô∏è Group creation failed ‚Äî install link unavailable offline');
          else await new Promise(r => setTimeout(r, 800)); // brief pause before retry
        }
      }
    }

    // Link this game to the group and notify existing subscribers
    if (cloudGroupId) {
      await apiGroupAddGame(cloudGroupId, code).catch(() => {});
      await apiGroupSetGame(cloudGroupId, code).catch(() => {}); // backwards compat
      const dateStr = gameDate
        ? new Date(gameDate).toLocaleDateString(undefined, { weekday:'short', day:'numeric', month:'short' })
          + ' at ' + new Date(gameDate).toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit' })
        : 'Tonight';
      apiGroupNotify(cloudGroupId,
        'üÉè New Game ‚Äî Claim Your Seat!',
        name + ' ¬∑ ' + dateStr + (location ? ' ¬∑ ' + location : '') + '. Tap to RSVP.',
        'all'
      ).catch(() => {});
    }
  }

  // Subscribe host for notifications
  if ('Notification' in window && Notification.permission !== 'denied') {
    registerServiceWorker();
    setTimeout(async () => {
      if (Notification.permission !== 'granted') {
        const perm = await Notification.requestPermission();
        if (perm === 'granted') {
          await new Promise(r => setTimeout(r, 800));
          await subscribePushToGroup('Host', code);
        }
      } else {
        await subscribePushToGroup('Host', code);
      }
    }, 1000);
  }

  startSyncPolling();
  btn.textContent = 'Create Game'; btn.disabled = false;
  closeNewGame();

  // Show lobby screen so host can send invite + watch seats fill up
  const inviteLink = buildGroupLink('rsvp');
  openLobby(name, stakes, gameDate, location, seats, inviteLink, code);

  } catch(err) {
    console.error('confirmNewGame error:', err);
    toast('Error creating game: ' + err.message);
    btn.textContent = 'Create Game'; btn.disabled = false;
  }
}

function buildGroupLink(mode) {
  const base = typeof APP_URL !== 'undefined' ? APP_URL : location.origin;
  const code = state.game && state.game.code && state.game.code !== 'LOCAL' ? state.game.code : null;
  // ALWAYS use the permanent group link ‚Äî players bookmark this once and it works for every future game
  // When a player opens it: lobby phase ‚Üí seat claim screen; live phase ‚Üí watch table
  if (cloudGroupId) return base + '#group=' + cloudGroupId;
  // Fallback if group hasn't been created yet (offline etc)
  if (mode === 'rsvp' && code) return base + '#rsvp=' + code;
  if (code) return base + '#join=' + code;
  return base;
}

function openLobby(name, stakes, gameDate, location, seats, inviteLink, code) {
  const dateStr = gameDate
    ? new Date(gameDate).toLocaleDateString(undefined, { weekday:'long', day:'numeric', month:'long' }) +
      ' at ' + new Date(gameDate).toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit' })
    : 'Tonight';

  const isPermanent = inviteLink.includes('#group=');
  document.getElementById('lobbyGameInfo').innerHTML =
    '<b style="color:var(--gold)">' + esc(name) + '</b><br>' +
    (stakes ? 'üìã ' + esc(stakes) + '<br>' : '') +
    'üìÖ ' + esc(dateStr) +
    (location ? '<br>üìç ' + esc(location) : '');

  // Wire Install button - opens WhatsApp with install link
  document.getElementById('lobbyInstallWaBtn').onclick = () => {
    const installUrl = buildInstallLink();
    if (installUrl) shareLink(installUrl, '‚ô† Install The Table to get game notifications:\n' + installUrl);
  };

  // Show install link copy row
  const installLink = buildInstallLink();
  const installRow = document.getElementById('lobbyInstallRow');
  if (installRow) {
    if (installLink) {
      installRow.style.display = 'block';
      document.getElementById('lobbyInstallUrl').textContent = installLink;
      document.getElementById('lobbyInstallCopyBtn').onclick = () => {
        copyText(installLink);
        document.getElementById('lobbyInstallCopyBtn').textContent = 'Copied!';
        setTimeout(() => document.getElementById('lobbyInstallCopyBtn').textContent = 'Copy', 1500);
      };
    } else {
      installRow.style.display = 'none';
    }
  }

  renderLobbySeats();

  // Build WA invite message for current game RSVP
  const waLines = [
    '\u2660 *' + name + '* \u2014 You\'re invited!',
    '',
    '\uD83D\uDCC5 ' + dateStr,
    stakes ? '\uD83D\uDCCB ' + stakes : '',
    location ? '\uD83D\uDCCD ' + location : '',
    '',
    'Tap to claim your seat' + (isPermanent ? ' (save this link ‚Äî it works for every game!)' : '') + ':',
    inviteLink,
    '',
    'See you at the table! \uD83C\uDCCF',
  ].filter(l => l !== undefined);
  const waMsg = waLines.join('\n');

  const waUrl = 'https://wa.me/?text=' + encodeURIComponent(waMsg);
  document.getElementById('lobbyWaBtn').onclick = () => { shareLink(inviteLink, '‚ô† ' + name + ' ‚Äî claim your seat:\n' + inviteLink); };

  // Start polling so seat claims show in real time
  lobbyPollInterval = setInterval(refreshLobbySeats, 2000);

  document.getElementById('lobbyOverlay').classList.add('show');
}

let lobbyPollInterval = null;
let selectedSeatForClaim = null;

async function refreshLobbySeats() {
  if (!cloudGameCode || cloudGameCode === 'LOCAL') return;
  try {
    const data = await apiGetGame(cloudGameCode);
    if (data.state) {
      state = data.state;
      saveState();
      // Update lobby overlay seats if the overlay is open
      if (document.getElementById('lobbySeats')) renderLobbySeats();
      // Only refresh home screen if we are actually on the home screen right now
      // NEVER call renderHome() if the game screen is visible ‚Äî that would kick the host out
      const homeScreen = document.getElementById('homeScreen');
      const gameScreen = document.getElementById('gameScreen');
      if (homeScreen && !homeScreen.hidden && gameScreen && gameScreen.hidden) {
        const homeBody = document.getElementById('homeBody');
        if (homeBody && homeBody.querySelector('#continueBtn')) renderHome();
      }
    }
  } catch(e) {}
}

function renderLobbySeats() {
  const seats = state.game ? state.game.seats : 10;
  const container = document.getElementById('lobbySeats');
  if (!container) return;
  let claimed = 0;
  let html2 = '';
  for (let i = 1; i <= seats; i++) {
    const sid = 'seat' + i;
    const p = state.players[sid];
    if (p && p.name) {
      claimed++;
      html2 += '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.15);border-radius:8px;margin-bottom:6px">' +
        '<div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:var(--cream)">' + esc(inits(p.name)) + '</div>' +
        '<div style="flex:1;font-size:0.9rem;color:var(--cream)">' + esc(p.name) + '</div>' +
        '<div style="font-size:0.8rem;color:var(--gold)">Seat ' + i + '</div>' +
        '</div>';
    }
  }
  if (!claimed) {
    html2 = '<div style="text-align:center;padding:20px;font-size:0.88rem;color:var(--muted)">No seats claimed yet ‚Äî send the invite!</div>';
  }
  container.innerHTML = html2;
}

function closeLobby() {
  if (lobbyPollInterval) { clearInterval(lobbyPollInterval); lobbyPollInterval = null; }
  document.getElementById('lobbyOverlay').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Enter game screen in read-only mode (player view)
function enterReadOnlyGame() {
  isReadOnly = true;
  openGame();
  applyReadOnlyMode();
}

// Apply read-only restrictions to game screen
function applyReadOnlyMode() {
  if (!isReadOnly) return;
  // Hide host-only controls
  const hideIds = ['publishBtn','settleBtn','endGameBtn','lbInGameBtn','backBtn','homeAddBtn','shareBtn'];
  hideIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  // Change back button for players
  const backBtn2 = document.getElementById('backBtn');
  if (backBtn2) backBtn2.textContent = '‚Üê Leave';
  // Show read-only badge
  const badge = document.getElementById('gameCodeBadge');
  if (badge) {
    badge.textContent = 'üëÅ LIVE VIEW';
    badge.style.display = 'block';
    badge.style.color = 'var(--muted)';
  }
  // Make seat chips non-clickable
  document.querySelectorAll('.seat-chip, .seat-empty').forEach(el => {
    el.style.pointerEvents = 'none';
    el.style.cursor = 'default';
  });
  // Show share button for spectators to share to others
  const shareBtn = document.getElementById('shareBtn');
  if (shareBtn) shareBtn.style.display = '';
}

function openGameWithPasswordCheck(onSuccess) {
  const pw = state.game && state.game.password;
  if (!pw) { onSuccess ? onSuccess() : openGame(); return; }
  // Show password prompt
  document.getElementById('pwInput').value = '';
  document.getElementById('pwError').textContent = '';
  document.getElementById('pwOverlay').classList.add('show');
  setTimeout(() => document.getElementById('pwInput').focus(), 100);
  // Store the callback so the confirm button knows what to do
  window._pwCallback = onSuccess || openGame;
}

function openGame() {
  showScreen('gameScreen');
  document.getElementById('topbarTitle').textContent = (state.game && state.game.name) || 'The Table';
  if (isReadOnly) setTimeout(applyReadOnlyMode, 50);
  const codeBadge = document.getElementById('gameCodeBadge');
  if (state.game && state.game.code && state.game.code !== 'LOCAL') {
    codeBadge.textContent = 'CODE: ' + state.game.code;
    codeBadge.style.display = 'block';
  } else {
    codeBadge.style.display = 'none';
  }
  // Resume sync if we had a role
  if (cloudGameCode && cloudRole) startSyncPolling();
  requestAnimationFrame(() => requestAnimationFrame(renderTable));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRMATION MODAL HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showConfirmModal(title, message, confirmLabel, onConfirm, danger) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:700;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:24px';
  const box = document.createElement('div');
  const isDanger = danger !== false; // default to danger style
  box.style.cssText = 'background:#09180a;border:1px solid ' + (isDanger ? 'rgba(231,76,60,0.4)' : 'rgba(201,168,76,0.3)') + ';border-radius:16px;padding:24px;width:100%;max-width:320px';
  const t = document.createElement('div');
  t.style.cssText = 'font-size:1rem;font-weight:700;color:' + (isDanger ? '#ff6b5b' : 'var(--gold)') + ';margin-bottom:10px';
  t.textContent = title;
  const m = document.createElement('div');
  m.style.cssText = 'font-size:0.9rem;color:var(--cream2);margin-bottom:20px;line-height:1.6';
  m.textContent = message;
  const yesBtn = document.createElement('button');
  yesBtn.style.cssText = 'width:100%;background:' + (isDanger ? 'linear-gradient(135deg,#c0392b,#8a2010)' : 'linear-gradient(135deg,var(--gold),#8a5c20)') + ';color:' + (isDanger ? '#fff' : '#000') + ';border:none;padding:13px;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;margin-bottom:10px;display:block';
  yesBtn.textContent = confirmLabel;
  const noBtn = document.createElement('button');
  noBtn.style.cssText = 'width:100%;background:none;border:1px solid var(--border);color:var(--muted);padding:12px;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.8rem;cursor:pointer;display:block';
  noBtn.textContent = 'Cancel';
  yesBtn.addEventListener('click', () => { overlay.remove(); onConfirm(); });
  noBtn.addEventListener('click', () => overlay.remove());
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  box.append(t, m, yesBtn, noBtn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function endGame() {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:600;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:24px';
  const box = document.createElement('div');
  box.style.cssText = 'background:#1a0a0a;border:1px solid rgba(231,76,60,0.5);border-radius:16px;padding:24px;width:100%;max-width:320px';
  const title = document.createElement('div');
  title.style.cssText = 'font-size:1.1rem;font-weight:700;color:#ff6b5b;margin-bottom:10px';
  title.textContent = 'End Game?';
  const msg = document.createElement('div');
  msg.style.cssText = 'font-size:0.9rem;color:var(--cream2);margin-bottom:20px;line-height:1.6';
  msg.textContent = 'This will save all results to the leaderboard and return to home.';
  const yesBtn = document.createElement('button');
  yesBtn.style.cssText = 'width:100%;background:linear-gradient(135deg,#c0392b,#8a2010);color:#fff;border:none;padding:13px;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;margin-bottom:10px;display:block';
  yesBtn.textContent = 'Yes, End Game';
  const noBtn = document.createElement('button');
  noBtn.style.cssText = 'width:100%;background:none;border:1px solid var(--border);color:var(--muted);padding:12px;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.82rem;cursor:pointer;display:block';
  noBtn.textContent = 'Cancel';
  yesBtn.addEventListener('click', async () => {
    overlay.remove();
    // Check if already settled
    const gameId = state.game && (state.game.code || state.game.startedAt || state.game.name);
    const alreadySettled = gameId && localStorage.getItem('settled_' + gameId);
    if (alreadySettled) {
      // Show already-settled dialog
      const d = document.createElement('div');
      d.style.cssText = 'position:fixed;inset:0;z-index:700;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:24px';
      d.innerHTML = '<div style="background:#0d1f10;border:1px solid var(--border2);border-radius:16px;padding:24px;width:100%;max-width:320px">' +
        '<div style="font-size:1rem;font-weight:700;color:var(--gold);margin-bottom:10px">Already Settled</div>' +
        '<div style="font-size:0.88rem;color:var(--cream2);margin-bottom:20px;line-height:1.6">This game has already been settled and saved to the leaderboard.</div>' +
        '<button id="unsettleBtn" style="width:100%;padding:12px;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);color:var(--red);border-radius:10px;font-size:0.88rem;font-weight:700;cursor:pointer;margin-bottom:8px">Unsettle &amp; Redo</button>' +
        '<button id="settleCancelBtn" style="width:100%;padding:12px;background:none;border:1px solid var(--border);color:var(--muted);border-radius:10px;font-size:0.88rem;cursor:pointer">Cancel</button>' +
        '</div>';
      document.body.appendChild(d);
      document.getElementById('settleCancelBtn').onclick = () => d.remove();
      document.getElementById('unsettleBtn').onclick = () => {
        // Remove settled flag and undo stats
        localStorage.removeItem('settled_' + gameId);
        // Remove from game history
        const hist = getGameHistory().filter(h => h.gameId !== gameId);
        saveGameHistory(hist);
        // Rebuild stats from scratch from remaining history
        rebuildStatsFromHistory();
        d.remove();
        toast('Unsettled ‚Äî you can now end the game again');
      };
      return;
    }
    recordStats();
    // Push a "game ended" flag to cloud BEFORE clearing state, so players detect it
    if (cloudRole === 'host' && cloudGameCode && cloudGameCode !== 'LOCAL') {
      const endedState = JSON.parse(JSON.stringify(state)); // deep copy
      endedState.game = Object.assign({}, endedState.game, { ended: true });
      await apiSetState(cloudGameCode, endedState).catch(() => {});
      // Remove from group's active games list
      if (cloudGroupId) await apiGroupEndGame(cloudGroupId, cloudGameCode).catch(() => {});
      // Notify all players game has ended
      await notifyAll('Game Over!', (state.game ? state.game.name : 'Poker Night') + ' has ended. Check your settlements!');
    }
    stopSyncPolling();
    setCloudRole(null, null, null);
    state.game = null; state.players = {};
    saveState(); renderHome();
    toast('Game ended ‚Äî results saved ‚úì');
  });
  noBtn.addEventListener('click', () => overlay.remove());
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  box.appendChild(title); box.appendChild(msg); box.appendChild(yesBtn); box.appendChild(noBtn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}


function rebuildStatsFromHistory() {
  const hist = getGameHistory();
  const stats = {};
  hist.forEach(game => {
    (game.players || []).forEach(p => {
      const k = p.name.toLowerCase();
      if (!stats[k]) stats[k] = { name: p.name, games: 0, net: 0, lastSeen: 0 };
      stats[k].games++;
      stats[k].net += p.net;
      stats[k].lastSeen = Date.now();
      stats[k].name = p.name;
    });
  });
  saveStats(stats);
}

function recordStats() {
  if (!state.game) return;
  // Use gameId to make settlement idempotent ‚Äî can't record same game twice
  const gameId = state.game.code || state.game.startedAt || state.game.name;
  const settledKey = 'settled_' + gameId;
  if (localStorage.getItem(settledKey)) {
    console.log('Game already settled ‚Äî skipping duplicate recordStats');
    return;
  }
  const stats = getStats();
  Object.values(state.players).filter(p => p && p.name && pBuyin(p) > 0).forEach(p => {
    const k = p.name.toLowerCase();
    if (!stats[k]) stats[k] = { name: p.name, games: 0, net: 0, lastSeen: 0 };
    stats[k].games++;
    stats[k].net += pNet(p);
    stats[k].lastSeen = Date.now();
    stats[k].name = p.name;
  });
  saveStats(stats);
  recordGameHistory(gameId);
  localStorage.setItem(settledKey, Date.now()); // mark as settled
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABLE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable() {
  if (!state.game) return;
  const wrap = document.getElementById('tableWrap');
  const W = wrap.offsetWidth, H = wrap.offsetHeight;
  if (!W || !H) { setTimeout(renderTable, 80); return; } // retry once layout settles

  // Vertical rectangle: taller than wide, scales with screen
  const tH = Math.min(H * 0.72, 480);
  const tW = Math.min(W * 0.42, tH * 0.52); // always narrower than tall
  const cx = W / 2, cy = H / 2;
  const pad = 14; // rail border thickness

  const outer = document.getElementById('tableOuter');
  outer.style.cssText = `width:${tW + pad*2}px;height:${tH + pad*2}px;left:${cx-(tW+pad*2)/2}px;top:${cy-(tH+pad*2)/2}px`;
  const felt = document.getElementById('tableFelt');
  felt.style.cssText = `width:${tW}px;height:${tH}px;left:${cx-tW/2}px;top:${cy-tH/2}px`;

  document.getElementById('tableName').textContent = state.game.name;
  const players = Object.values(state.players).filter(p => p && p.name);
  const active = players.filter(p => pBuyin(p) > 0 && pCash(p) === 0).length;
  document.getElementById('tableStats').textContent = players.length ? `${active} active ¬∑ ${players.length} seated` : '';
  buildSeats(state.game.seats, tW, tH, cx, cy);
  updateBank();
}

function buildSeats(count, tW, tH, cx, cy) {
  const cont = document.getElementById('seatsContainer');
  cont.innerHTML = '';

  // Seat chip size scales with table width
  const chipSize = Math.max(30, Math.min(tW * 0.22, 44));
  const seatGap = chipSize + 8; // distance from table edge to seat center

  // Layout: seat 1 = top center, seat N/2+1 = bottom center, rest split L/R along long sides
  const sideCount = count - 2;
  const leftCount = Math.ceil(sideCount / 2);
  const rightCount = Math.floor(sideCount / 2);

  const hOff = tW / 2 + seatGap; // x-offset for left/right columns
  const vOff = tH / 2 + seatGap; // y-offset for top/bottom seats

  const positions = [];

  // Seat 1: top center
  positions.push({ x: cx, y: cy - vOff });

  // Left side: evenly spaced down the long left edge
  for (let i = 0; i < leftCount; i++) {
    const spacing = tH / (leftCount + 1);
    const yOff = -tH / 2 + spacing * (i + 1);
    positions.push({ x: cx - hOff, y: cy + yOff });
  }

  // Bottom center
  positions.push({ x: cx, y: cy + vOff });

  // Right side: evenly spaced down the long right edge
  for (let i = 0; i < rightCount; i++) {
    const spacing = tH / (rightCount + 1);
    const yOff = -tH / 2 + spacing * (i + 1);
    positions.push({ x: cx + hOff, y: cy + yOff });
  }

  positions.forEach((pos, i) => {
    const sid = 'seat' + (i + 1);
    const p = state.players[sid];
    const seat = document.createElement('div');
    seat.className = 'seat';
    seat.style.left = pos.x + 'px';
    seat.style.top = pos.y + 'px';

    const cs = chipSize + 'px';
    const initFs = Math.max(8, chipSize * 0.34) + 'px';
    const emptyFs = Math.max(12, chipSize * 0.52) + 'px';

    if (p && p.name) {
      const bi = pBuyin(p), co = pCash(p), net = pNet(p);
      const isRsvp = p.rsvp && bi === 0; // reserved but not yet bought in
      const cls = co > 0 ? 'cashed' : isRsvp ? 'rsvp' : 'seated';
      const netHtml = bi > 0 ? `<div class="seat-net ${nc(net)}">${fmtNet(net)}</div>` : (isRsvp ? `<div class="seat-net" style="color:var(--muted);font-size:0.88rem">RSVP</div>` : '');
      seat.innerHTML = `<div class="seat-chip ${cls}" style="width:${cs};height:${cs};${isRsvp?'border-style:dashed;opacity:0.7':''}">`+
        `<span class="seat-inner" style="font-size:${initFs}">${esc(inits(p.name))}</span></div>`+
        `<div class="seat-label">${esc(p.name)}</div>${netHtml}`;
    } else {
      seat.innerHTML = `<div class="seat-chip empty" style="width:${cs};height:${cs}"><span class="seat-inner" style="font-size:${emptyFs}">+</span></div><div class="seat-label" style="opacity:0.3;font-size:0.88rem;font-weight:400">Seat ${i+1}</div>`;
    }

    const capturedSid = sid;
    seat.addEventListener('click', () => onSeatClick(capturedSid));
    cont.appendChild(seat);
  });
}

function onSeatClick(sid) {
  if (isReadOnly) return; // players cannot edit anything
  const p = state.players[sid];
  if (p && p.name) openPanel(sid);
  else openAssign(sid);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BANK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBank() {
  const players = Object.values(state.players).filter(p => p && p.name);
  const totalIn = players.reduce((a, p) => a + pBuyin(p), 0);
  const totalOut = players.reduce((a, p) => a + pCash(p), 0);
  const inBank = totalIn - totalOut;
  const active = players.filter(p => pBuyin(p) > 0 && pCash(p) === 0).length;
  document.getElementById('bbIn').textContent = fmt(totalIn) + ' in';
  document.getElementById('bbBank').textContent = fmt(inBank) + ' bank';
  document.getElementById('bcIn').textContent = fmt(totalIn);
  document.getElementById('bcOut').textContent = fmt(totalOut);
  document.getElementById('bcBank').textContent = fmt(inBank);
  document.getElementById('bcBankSub').textContent = inBank >= 0 ? 'still on table' : 'over-cashed!';
  document.getElementById('bcStatus').textContent = active + ' Active';
  const cashed = players.filter(p => pCash(p) > 0).length;
  document.getElementById('bcStatusSub').textContent = cashed ? cashed + ' cashed out' : '';
}

function toggleBank() {
  const panel = document.getElementById('bankPanel');
  const bar = document.getElementById('bankBar');
  panel.classList.toggle('open');
  bar.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASSIGN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let assigningSid = null;

function openAssign(sid) {
  if (!state.game) { toast('Start a game first!'); openNewGame(); return; }
  assigningSid = sid;
  document.getElementById('assignName').value = '';
  document.getElementById('assignPhone').value = '';
  // Known players
  const hist = getHistory();
  const seated = new Set(Object.values(state.players).filter(p => p && p.name).map(p => p.name.toLowerCase()));
  const wrap = document.getElementById('knownWrap');
  const list = document.getElementById('knownList');
  if (hist.length) {
    list.innerHTML = hist.map(n => `<button class="known-chip${seated.has(n.toLowerCase()) ? ' seated' : ''}" data-name="${esc(n)}">${esc(n)}</button>`).join('');
    list.querySelectorAll('.known-chip:not(.seated)').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('assignName').value = btn.dataset.name;
        const ph = getPhone(btn.dataset.name);
        document.getElementById('assignPhone').value = ph && ph.startsWith('61') ? '0' + ph.slice(2) : ph;
      });
    });
    wrap.style.display = 'block';
  } else {
    wrap.style.display = 'none';
  }
  document.getElementById('assignOverlay').classList.add('show');
  setTimeout(() => document.getElementById('assignName').focus(), 100);
}

function closeAssign() {
  document.getElementById('assignOverlay').classList.remove('show');
  assigningSid = null;
}

function confirmAssign() {
  const name = (document.getElementById('assignName').value || '').trim();
  if (!name) { toast('Enter a name'); return; }
  const phone = (document.getElementById('assignPhone').value || '').trim();
  if (phone) setPhone(name, phone);
  const sid = assigningSid; // capture BEFORE closeAssign nulls it
  // Preserve existing player data if re-assigning (e.g. name change)
  const existing = state.players[sid] || {};
  state.players[sid] = { ...existing, name, transactions: existing.transactions || [] };
  addHistory(name);
  saveState();
  syncToCloud().catch(() => {}); // push to cloud immediately so it isn't overwritten
  closeAssign();
  renderTable();
  setTimeout(() => openPanel(sid), 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activePanel = null;

function openPanel(sid) {
  activePanel = sid;
  document.getElementById('sidePanel').classList.add('open');
  requestAnimationFrame(() => buildPanel(sid)); // render after panel is visible
}

function closePanel() {
  document.getElementById('sidePanel').classList.remove('open');
  activePanel = null;
  setTimeout(() => renderTable(), 270);
}

function buildPanel(sid) {
  const p = state.players[sid];
  if (!p) return;
  document.getElementById('panelTitle').textContent = p.name;
  const body = document.getElementById('panelBody');
  body.innerHTML = '';
  const bi = pBuyin(p), co = pCash(p), net = pNet(p);

  // Summary
  const sum = document.createElement('div');
  sum.className = 'p-sum';
  sum.innerHTML = '<div class="p-av">' + esc(inits(p.name)) + '</div><div class="p-info"><div class="p-name">' + esc(p.name) + '</div><div class="p-meta">Seat ' + sid.replace('seat','') + ' &nbsp;&middot;&nbsp; In: ' + fmt(bi) + ' &middot; Out: ' + fmt(co) + '</div></div><div class="p-net ' + nc(net) + '" id="pNetDisplay">' + fmtNet(net) + '</div>';
  body.appendChild(sum);

  // Transactions
  const txSec = document.createElement('div'); txSec.className = 'psec'; txSec.textContent = 'Transactions';
  body.appendChild(txSec);
  const txList = document.createElement('div');
  const txs = p.transactions || [];
  if (!txs.length) {
    txList.innerHTML = '<div style="font-size:0.85rem;color:var(--muted);padding:10px 0;text-align:center">No transactions yet</div>';
  } else {
    txs.forEach((tx, idx) => {
      const typeLabel = tx.type === 'cashout' ? 'Cash out' : 'Buy-in';
      const typeCls   = tx.type === 'cashout' ? 'co' : 'bi';
      const time = new Date(tx.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const row = document.createElement('div'); row.className = 'tx-row';
      const badge = document.createElement('span'); badge.className = 'tx-badge ' + typeCls; badge.textContent = typeLabel;
      const amt = document.createElement('input');
      amt.className = 'tx-amt'; amt.type = 'number'; amt.inputMode = 'decimal'; amt.value = tx.amount.toFixed(2);
      amt.addEventListener('click', () => amt.select());
      amt.addEventListener('mousedown', e => e.stopPropagation()); // prevent panel closing
      const saveTxAmt = () => {
        const v = parseFloat(amt.value);
        if (isNaN(v) || v <= 0) return;
        p.transactions[idx].amount = v; saveState(); refreshPanelSummary(sid); renderTable();
        syncToCloud().catch(() => {});
      };
      amt.addEventListener('blur', saveTxAmt);
      amt.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); amt.blur(); } });
      const timeEl = document.createElement('span'); timeEl.className = 'tx-time'; timeEl.textContent = time;
      // Delete: single tap shows confirmation modal
      const del = document.createElement('button'); del.className = 'tx-del'; del.textContent = '‚úï';
      del.addEventListener('click', () => {
        showConfirmModal(
          'Delete Transaction?',
          typeLabel + ' of $' + tx.amount.toFixed(2) + ' for ' + p.name,
          'Delete',
          () => {
            const p2 = state.players[sid];
            if (!p2) return;
            p2.transactions.splice(idx, 1);
            saveState(); buildPanel(sid); renderTable();
            syncToCloud().catch(() => {});
          }
        );
      });
      row.append(badge, amt, timeEl, del);
      txList.appendChild(row);
    });
  }
  body.appendChild(txList);

  // Buy-in (also used for rebuys ‚Äî each tap adds another buy-in entry)
  const biSec = document.createElement('div'); biSec.className = 'psec'; biSec.textContent = 'Buy-in';
  body.appendChild(biSec);
  const biRow = document.createElement('div'); biRow.className = 'add-row';
  const biInp = document.createElement('input');
  biInp.className = 'add-inp'; biInp.type = 'number'; biInp.inputMode = 'decimal'; biInp.placeholder = 'Amount'; biInp.id = 'biInput';
  const biBtn = document.createElement('button'); biBtn.className = 'add-btn'; biBtn.textContent = '+ Buy In';
  biBtn.addEventListener('click', () => addTxFromInput(sid, 'buyin', biInp));
  biInp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addTxFromInput(sid, 'buyin', biInp); } });
  biRow.append(biInp, biBtn);
  body.appendChild(biRow);

  // Cash Out
  const coSec = document.createElement('div'); coSec.className = 'psec'; coSec.textContent = 'Cash Out';
  body.appendChild(coSec);
  const coRow = document.createElement('div'); coRow.className = 'add-row';
  const coInp = document.createElement('input');
  coInp.className = 'add-inp'; coInp.type = 'number'; coInp.inputMode = 'decimal'; coInp.placeholder = 'Amount'; coInp.id = 'coInput';
  const coBtn = document.createElement('button'); coBtn.className = 'add-btn g'; coBtn.textContent = 'Cash Out';
  coBtn.addEventListener('click', () => addTxFromInput(sid, 'cashout', coInp));
  coInp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addTxFromInput(sid, 'cashout', coInp); } });
  coRow.append(coInp, coBtn);
  body.appendChild(coRow);

  // WhatsApp
  const waSec = document.createElement('div'); waSec.className = 'psec'; waSec.textContent = 'WhatsApp';
  body.appendChild(waSec);
  const phone = getPhone(p.name);
  if (phone) {
    const balMsg = 'Hey ' + p.name + '! Update from ' + (state.game ? state.game.name : 'Poker Night') + ' - balance: ' + fmtNet(net) + ' (spade)';
    const preview = document.createElement('div');
    preview.style.cssText = 'background:#0a1f0c;border:1px solid rgba(201,168,76,0.15);border-radius:6px;padding:8px 10px;margin-bottom:7px;font-size:0.88rem;color:var(--cream2);line-height:1.5';
    preview.textContent = 'Hey ' + p.name + '! Update from ' + (state.game ? state.game.name : 'Poker Night') + ' - balance: ' + fmtNet(net);
    body.appendChild(preview);
    const waLink = document.createElement('a');
    waLink.className = 'wa-btn'; waLink.href = waUrl(phone, 'Hey ' + p.name + '! Update from ' + (state.game ? state.game.name : 'Poker Night') + ' - balance: ' + fmtNet(net)); waLink.target = '_blank';
    waLink.textContent = 'Send Balance Update';
    body.appendChild(waLink);
  } else {
    const noNum = document.createElement('div');
    noNum.style.cssText = 'font-size:0.85rem;color:var(--muted);padding:4px 0 8px';
    noNum.textContent = 'No number saved - add one in Contacts tab.';
    body.appendChild(noNum);
  }

  // Player QR Code
  const qrSec = document.createElement('div'); qrSec.className = 'psec'; qrSec.textContent = 'Player QR Code';
  body.appendChild(qrSec);
  const qrNote = document.createElement('div');
  qrNote.style.cssText = 'font-size:0.82rem;color:var(--muted);margin-bottom:8px;line-height:1.5';
  qrNote.textContent = p.name + ' can scan this to watch their live balance.';
  body.appendChild(qrNote);
  const qrWrap = document.createElement('div');
  qrWrap.style.cssText = 'display:flex;justify-content:center;margin-bottom:6px';
  const qrCanvas = document.createElement('canvas');
  qrCanvas.style.cssText = 'border-radius:6px;background:#fff;padding:6px';
  qrWrap.appendChild(qrCanvas);
  body.appendChild(qrWrap);
  // Use group link (permanent) or join link ‚Äî not #live= which is just a scoreboard
  const _base = typeof APP_URL !== 'undefined' ? APP_URL : location.origin + location.pathname;
  const playerUrl = cloudGroupId ? _base + '#group=' + cloudGroupId
                  : (state.game && state.game.code && state.game.code !== 'LOCAL') ? _base + '#join=' + state.game.code
                  : _base;
  const qrUrlEl = document.createElement('div');
  qrUrlEl.style.cssText = 'font-size:0.88rem;text-align:center;color:var(--muted);word-break:break-all;line-height:1.4;margin-bottom:4px';
  qrUrlEl.textContent = playerUrl;
  body.appendChild(qrUrlEl);
  requestAnimationFrame(() => drawQR(qrCanvas, playerUrl, 130));

  // Change Seat
  const csSec = document.createElement('div'); csSec.className = 'psec'; csSec.textContent = 'Change Seat';
  body.appendChild(csSec);
  const csNote = document.createElement('div');
  csNote.style.cssText = 'font-size:0.82rem;color:var(--muted);margin-bottom:8px';
  csNote.textContent = 'Tap a seat to move or swap.';
  body.appendChild(csNote);
  const csGrid = document.createElement('div');
  csGrid.style.cssText = 'display:flex;flex-wrap:wrap;gap:5px;margin-bottom:4px';
  const totalSeats = state.game ? state.game.seats : 10;
  for (let i = 1; i <= totalSeats; i++) {
    const tSid = 'seat' + i;
    if (tSid === sid) continue;
    const occ = state.players[tSid] && state.players[tSid].name;
    const btn = document.createElement('button');
    btn.style.cssText = 'padding:5px 9px;font-size:0.82rem;border-radius:5px;cursor:pointer;font-family:DM Sans,sans-serif;border:1px solid ' + (occ ? 'rgba(231,76,60,0.35)' : 'rgba(201,168,76,0.3)') + ';background:' + (occ ? 'rgba(231,76,60,0.08)' : 'rgba(201,168,76,0.07)') + ';color:' + (occ ? 'var(--red)' : 'var(--gold)');
    btn.textContent = 'Seat ' + i + (occ ? ' (' + inits(state.players[tSid].name) + ')' : ' empty');
    btn.addEventListener('click', () => {
      if (occ) {
        const tmp = state.players[tSid];
        state.players[tSid] = state.players[sid];
        state.players[sid] = tmp;
      } else {
        state.players[tSid] = state.players[sid];
        state.players[sid] = null;
      }
      saveState(); renderTable(); openPanel(tSid);
    });
    csGrid.appendChild(btn);
  }
  body.appendChild(csGrid);

  // Remove from Seat ‚Äî single tap shows inline confirm row
  const rmSec = document.createElement('div'); rmSec.className = 'psec'; rmSec.textContent = 'Remove Player';
  body.appendChild(rmSec);
  const rmBtn = document.createElement('button');
  rmBtn.className = 'remove-btn'; rmBtn.textContent = 'Remove from Seat';
  rmBtn.addEventListener('click', () => {
    // Replace button with confirm row
    rmBtn.style.display = 'none';
    const confirmRow = document.createElement('div');
    confirmRow.style.cssText = 'display:flex;gap:7px;align-items:center';
    const confirmMsg = document.createElement('span');
    confirmMsg.style.cssText = 'font-size:0.85rem;color:var(--red);flex:1';
    confirmMsg.textContent = 'Remove ' + p.name + '?';
    const yesBtn = document.createElement('button');
    yesBtn.style.cssText = 'background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.4);color:var(--red);padding:7px 12px;border-radius:6px;font-family:DM Sans,sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer';
    yesBtn.textContent = 'Yes, Remove';
    const cancelBtn = document.createElement('button');
    cancelBtn.style.cssText = 'background:none;border:1px solid var(--border);color:var(--muted);padding:7px 10px;border-radius:6px;font-family:DM Sans,sans-serif;font-size:0.88rem;cursor:pointer';
    cancelBtn.textContent = 'Cancel';
    yesBtn.addEventListener('click', () => {
      state.players[sid] = null;
      saveState(); closePanel(); renderTable();
      toast(p.name + ' removed from seat');
    });
    cancelBtn.addEventListener('click', () => {
      confirmRow.remove(); rmBtn.style.display = '';
    });
    confirmRow.append(confirmMsg, yesBtn, cancelBtn);
    body.appendChild(confirmRow);
  });
  body.appendChild(rmBtn);
}

function refreshPanelSummary(sid) {
  const p = state.players[sid];
  if (!p) return;
  const el = document.getElementById('pNetDisplay');
  if (el) { const n = pNet(p); el.className = 'p-net ' + nc(n); el.textContent = fmtNet(n); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// addTxFromInput: called with direct element reference (avoids getElementById after panel rebuild)
function addTxFromInput(sid, type, inp) {
  const p = state.players[sid];
  if (!p) return;
  const amt = parseFloat(inp ? inp.value : 0);
  if (isNaN(amt) || amt <= 0) { toast('Enter a valid amount'); return; }
  p.transactions = p.transactions || [];
  p.transactions.push({ type, amount: amt, ts: Date.now() });
  saveState();
  if (inp) inp.value = '';
  buildPanel(sid);
  renderTable();
  const gameName = state.game ? state.game.name : 'Poker Night';
  let pushTitle, pushBody;
  if (type === 'buyin') {
    pushTitle = '‚ô† Buy-in recorded ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' is in at ' + gameName + '. Good luck!';
  } else if (type === 'rebuy') {
    pushTitle = '‚ô† Rebuy ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' rebuys at ' + gameName + '. Total in: $' + pBuyin(p).toFixed(2);
  } else {
    pushTitle = '‚ô† Cashed out ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' finishes ' + fmtNet(pNet(p)) + ' at ' + gameName;
  }
  notifyPlayer(p.name, pushTitle, pushBody);
  syncToCloud().catch(() => {});
  const phone = getPhone(p.name);
  if (phone) {
    let msg;
    if (type === 'buyin' || type === 'rebuy') {
      msg = '‚ô† Hi ' + p.name + '! ' + (type === 'rebuy' ? 'Rebuy' : 'Buy-in') + ': $' + amt.toFixed(2) + ' at ' + gameName + '. Good luck! üÉè';
    } else {
      msg = '‚ô† ' + p.name + ' ‚Äî cashed out $' + amt.toFixed(2) + ' at ' + gameName + '. Net: ' + fmtNet(pNet(p)) + ' üÉè';
    }
    showWaToast(phone, msg);
  }
}

function addTx(sid, type) {
  const p = state.players[sid];
  if (!p) return;
  const inpId = type === 'cashout' ? 'coInput' : 'biInput';
  const inp = document.getElementById(inpId);
  const amt = parseFloat(inp ? inp.value : 0);
  if (isNaN(amt) || amt <= 0) { toast('Enter a valid amount'); return; }
  p.transactions = p.transactions || [];
  p.transactions.push({ type, amount: amt, ts: Date.now() });
  saveState();
  inp.value = '';
  buildPanel(sid);
  renderTable();
  // Push notification to that player
  const gameName = state.game ? state.game.name : 'Poker Night';
  let pushTitle, pushBody;
  if (type === 'buyin') {
    pushTitle = '‚ô† Buy-in recorded ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' is in at ' + gameName + '. Good luck!';
  } else if (type === 'rebuy') {
    pushTitle = '‚ô† Rebuy ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' rebuys at ' + gameName + '. Total in: $' + pBuyin(p).toFixed(2);
  } else {
    pushTitle = '‚ô† Cashed out ‚Äî $' + amt.toFixed(2);
    pushBody  = p.name + ' finishes ' + fmtNet(pNet(p)) + ' at ' + gameName;
  }
  notifyPlayer(p.name, pushTitle, pushBody);
  syncToCloud().catch(() => {}); // push updated state immediately

  // WA notification (existing)
  const phone = getPhone(p.name);
  if (phone) {
    let msg;
    if (type === 'buyin' || type === 'rebuy') {
      msg = '‚ô† Hi ' + p.name + '! ' + (type === 'rebuy' ? 'Rebuy' : 'Buy-in') + ': $' + amt.toFixed(2) + ' at ' + gameName + '. Good luck! üÉè';
    } else {
      msg = '‚ô† ' + p.name + ' ‚Äî cashed out $' + amt.toFixed(2) + ' at ' + gameName + '. Net: ' + fmtNet(pNet(p)) + ' üÉè';
    }
    showWaToast(phone, msg);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function waUrl(phone, msg) {
  return 'https://wa.me/' + phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg);
}

function sharePublishResults() {
  const btn = document.getElementById('waGroupShareBtn');
  const url = btn.dataset.shareUrl || document.getElementById('publishUrl').value;
  const text = btn.dataset.shareText || '‚ô† Game results: ' + url;
  shareLink(url, text);
}

// Native share sheet ‚Äî works on all phones via WhatsApp, iMessage, Signal, email or copy
async function shareLink(url, text) {
  if (navigator.share) {
    try {
      await navigator.share({ title: '‚ô† The Table', text: text || '', url: url });
      return;
    } catch(e) {
      if (e.name === 'AbortError') return; // user cancelled ‚Äî do nothing
    }
  }
  // Fallback: copy to clipboard + toast
  try {
    await navigator.clipboard.writeText(text ? text + '\n' + url : url);
    toast('Link copied to clipboard!');
  } catch(e) {
    // Last resort: prompt
    window.prompt('Copy this link:', url);
  }
}

let waToastTimer = null;
function showWaToast(phone, msg) {
  clearTimeout(waToastTimer);
  document.getElementById('waToastMsg').textContent = msg;
  document.getElementById('waToastSend').href = waUrl(phone, msg);
  document.getElementById('waToast').classList.add('show');
  waToastTimer = setTimeout(hideWaToast, 20000);
}
function hideWaToast() {
  document.getElementById('waToast').classList.remove('show');
  clearTimeout(waToastTimer);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD (in-game sheet)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lbTab = 'all';

function openLeaderboard() {
  lbTab = 'all';
  renderLbSheet();
  document.getElementById('lbSheet').classList.add('show');
}
function closeLbSheet() {
  document.getElementById('lbSheet').classList.remove('show');
}
function switchLbTab(tab) {
  lbTab = tab;
  document.getElementById('lbTabAll').classList.toggle('active', tab === 'all');
  document.getElementById('lbTabGame').classList.toggle('active', tab === 'game');
  renderLbSheet();
}
function renderLbSheet() {
  const body = document.getElementById('lbBody');
  let players;
  if (lbTab === 'all') {
    const stats = getStats(), merged = {};
    Object.values(stats).forEach(s => { merged[s.name.toLowerCase()] = { name: s.name, games: s.games, net: s.net }; });
    Object.values(state.players || {}).filter(p => p && p.name && pBuyin(p) > 0).forEach(p => {
      const k = p.name.toLowerCase();
      if (!merged[k]) merged[k] = { name: p.name, games: 0, net: 0 };
      merged[k].games++; merged[k].net += pNet(p);
    });
    players = Object.values(merged).sort((a, b) => b.net - a.net);
  } else {
    players = Object.entries(state.players || {}).filter(([, p]) => p && p.name).map(([, p]) => ({ name: p.name, games: 1, net: pNet(p) })).sort((a, b) => b.net - a.net);
  }
  if (!players.length) { body.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px;font-size:0.82rem">No data yet</div>'; return; }
  body.innerHTML = players.map((p, i) => `
    <div class="lb-row">
      <div class="lb-rank">${i === 0 ? 'üèÜ' : '#' + (i + 1)}</div>
      <div class="lb-av">${esc(inits(p.name))}</div>
      <div class="lb-info"><div class="lb-name">${esc(p.name)}</div><div class="lb-sub">${p.games} game${p.games !== 1 ? 's' : ''}</div></div>
      <div class="lb-net ${nc(p.net)}">${fmtNet(p.net)}</div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openShare() {
  const base = typeof APP_URL !== 'undefined' ? APP_URL : location.origin + location.pathname;
  const code = state.game && state.game.code && state.game.code !== 'LOCAL' ? state.game.code : null;
  // Use permanent group link ‚Äî players save once, works forever
  const url = cloudGroupId ? base + '#group=' + cloudGroupId
              : code ? base + '#join=' + code
              : base;
  document.getElementById('shareUrl').textContent = url;
  drawQR(document.getElementById('shareQR'), url, 160);
  const lbl = document.getElementById('shareUrlLabel');
  if (lbl) lbl.textContent = cloudGroupId
    ? 'üîó Permanent group link ‚Äî share once, works for all future games'
    : 'üîó Game link (this game only)';
  document.getElementById('shareSheet').classList.add('show');
}
function closeShare() {
  document.getElementById('shareSheet').classList.remove('show');
}

// ‚îÄ‚îÄ QR Code using qrcode.js library (loaded via CDN) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawQR(canvas, text, size) {
  canvas.width = size;
  canvas.height = size;
  try {
    // qrcodejs needs a div container, we create a temp one
    const tmp = document.createElement('div');
    tmp.style.cssText = 'position:absolute;left:-9999px;top:-9999px';
    document.body.appendChild(tmp);
    new QRCode(tmp, {
      text: text,
      width: size,
      height: size,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
    // qrcodejs creates an img inside tmp ‚Äî draw it onto our canvas
    const img = tmp.querySelector('img') || tmp.querySelector('canvas');
    if (img) {
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);
      if (img.tagName === 'CANVAS') {
        ctx.drawImage(img, 0, 0, size, size);
        document.body.removeChild(tmp);
      } else {
        img.onload = () => {
          ctx.drawImage(img, 0, 0, size, size);
          document.body.removeChild(tmp);
        };
        if (img.complete) {
          ctx.drawImage(img, 0, 0, size, size);
          document.body.removeChild(tmp);
        }
      }
    } else {
      document.body.removeChild(tmp);
      drawQRFallback(canvas, text, size);
    }
  } catch(e) {
    console.warn('QR error:', e);
    drawQRFallback(canvas, text, size);
  }
}

function drawQRFallback(canvas, text, size) {
  // If library fails, show the URL as text
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, size, size);
  ctx.fillStyle = '#1e6b2a';
  ctx.fillRect(4, 4, size - 8, size - 8);
  ctx.fillStyle = '#c9a84c';
  ctx.textAlign = 'center';
  ctx.font = 'bold 11px monospace';
  ctx.fillText('Scan URL below', size / 2, size / 2 - 6);
  ctx.font = '9px monospace';
  ctx.fillStyle = '#ffffff';
  ctx.fillText('(open link directly)', size / 2, size / 2 + 10);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUBLISH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTLEMENT CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcSettlements(players) {
  // Minimum transfers algorithm using greedy creditor/debtor matching
  // players: [{name, net}]  (net = cashout - buyin, positive = winner)
  const debtors  = players.filter(p => p.net < -0.005).map(p => ({ name: p.name, amount: -p.net })).sort((a,b) => b.amount - a.amount);
  const creditors = players.filter(p => p.net >  0.005).map(p => ({ name: p.name, amount: p.net })).sort((a,b) => b.amount - a.amount);
  const transfers = [];
  let i = 0, j = 0;
  while (i < debtors.length && j < creditors.length) {
    const pay  = debtors[i];
    const recv = creditors[j];
    const amt  = Math.min(pay.amount, recv.amount);
    if (amt > 0.005) transfers.push({ from: pay.name, to: recv.name, amount: amt });
    pay.amount  -= amt;
    recv.amount -= amt;
    if (pay.amount  < 0.005) i++;
    if (recv.amount < 0.005) j++;
  }
  return transfers;
}

function renderSettlementsHTML(transfers, showWa) {
  // showWa: whether to show WhatsApp send buttons
  if (!transfers.length) {
    return '<div class="settle-clean">‚úì Everyone is square ‚Äî no transfers needed!</div>';
  }
  return transfers.map(t => {
    const phone = getPhone(t.to);
    const msg = '‚ô† Hey ' + t.to + '! ' + t.from + ' owes you $' + t.amount.toFixed(2) + ' from ' + (state.game ? state.game.name : 'Poker Night') + '. Time to collect! üÉè';
    const waHref = phone ? waUrl(phone, msg) : '';
    return `<div class="settle-row">
      <div class="settle-from">
        <div class="settle-av">${esc(inits(t.from))}</div>
        <div class="settle-nm">${esc(t.from)}</div>
      </div>
      <div class="settle-arrow">
        <div class="settle-arrow-line">‚Üí</div>
        <div class="settle-amount">$${t.amount.toFixed(2)}</div>
      </div>
      <div class="settle-to">
        <div class="settle-av">${esc(inits(t.to))}</div>
        <div class="settle-nm">${esc(t.to)}</div>
      </div>
      ${showWa && waHref ? `<a class="settle-wa" href="${waHref}" target="_blank">üí¨ Remind</a>` : ''}
    </div>`;
  }).join('');
}

function buildSettleSummaryText(transfers, gameName) {
  if (!transfers.length) return gameName + ' - Everyone is square! No transfers needed.';
  const lines = transfers.map(t => t.from + ' pays ' + t.to + ' $' + t.amount.toFixed(2));
  return gameName + ' - Settle Up\n\n' + lines.join('\n') + '\n\nSent from The Table ‚ô†';
}

function openSettleUp() {
  const players = Object.values(state.players || {})
    .filter(p => p && p.name && pBuyin(p) > 0)
    .map(p => ({ name: p.name, net: pNet(p) }));
  if (players.length < 2) { toast('Need at least 2 players'); return; }
  showConfirmModal(
    'üí∏ Settle Up?',
    'This will calculate and show final settlements for all ' + players.length + ' players.',
    'Show Settlements',
    () => _doOpenSettleUp(players)
  );
}
function _doOpenSettleUp(players) {

  const transfers = calcSettlements(players);
  const gameName = state.game ? state.game.name : 'Poker Night';
  const summaryText = buildSettleSummaryText(transfers, gameName);

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:600;background:rgba(0,0,0,0.85);display:flex;align-items:flex-end;justify-content:center';
  const box = document.createElement('div');
  box.style.cssText = 'background:#09180a;border-top:1px solid rgba(201,168,76,0.3);border-radius:16px 16px 0 0;width:100%;max-width:560px;max-height:88vh;display:flex;flex-direction:column';

  // ‚îÄ‚îÄ Header
  const hdr = document.createElement('div');
  hdr.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0';
  hdr.innerHTML = '<div><div style="font-size:1.1rem;font-weight:700;color:var(--cream)">üí∏ Settle Up</div><div style="font-size:0.82rem;color:var(--muted);margin-top:2px">' + (transfers.length ? transfers.length + ' transfer' + (transfers.length !== 1 ? 's' : '') + ' needed' : 'Everyone is square!') + '</div></div>';
  const closeBtn = document.createElement('button');
  closeBtn.style.cssText = 'background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;padding:4px 8px';
  closeBtn.textContent = '‚úï';
  closeBtn.addEventListener('click', () => overlay.remove());
  hdr.appendChild(closeBtn);
  box.appendChild(hdr);

  // ‚îÄ‚îÄ Share to group banner (the big feature)
  const groupBanner = document.createElement('div');
  groupBanner.style.cssText = 'padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(37,211,102,0.04)';
  
  const bannerLabel = document.createElement('div');
  bannerLabel.style.cssText = 'font-size:0.9rem;text-transform:uppercase;letter-spacing:2px;color:rgba(37,211,102,0.7);margin-bottom:8px';
  bannerLabel.textContent = 'Send to your group chat';
  groupBanner.appendChild(bannerLabel);

  const groupBtns = document.createElement('div');
  groupBtns.style.cssText = 'display:flex;gap:8px';

  // WhatsApp group button
  const waGroupBtn = document.createElement('a');
  waGroupBtn.style.cssText = 'flex:1;display:flex;align-items:center;justify-content:center;gap:7px;background:#25D366;color:#fff;padding:12px;border-radius:10px;font-size:0.82rem;font-weight:700;text-decoration:none;cursor:pointer';
  waGroupBtn.removeAttribute('href');
  waGroupBtn.innerHTML = '<span style="font-size:1.1rem">üì§</span> Share Summary';
  waGroupBtn.addEventListener('click', () => {
    shareLink(APP_URL || location.origin, summaryText);
    setTimeout(() => overlay.remove(), 400);
  });

  // Copy button
  const copyBtn = document.createElement('button');
  copyBtn.style.cssText = 'display:flex;align-items:center;justify-content:center;gap:6px;background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);color:var(--gold);padding:12px 16px;border-radius:10px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:DM Sans,sans-serif;white-space:nowrap';
  copyBtn.innerHTML = 'üìã Copy';
  copyBtn.addEventListener('click', () => { copyText(summaryText); });

  groupBtns.appendChild(waGroupBtn);
  groupBtns.appendChild(copyBtn);
  groupBanner.appendChild(groupBtns);

  // Preview of the message that will be sent
  const preview = document.createElement('div');
  preview.style.cssText = 'margin-top:10px;background:rgba(0,0,0,0.3);border-radius:8px;padding:9px 11px;font-size:0.82rem;color:var(--cream2);line-height:1.7;white-space:pre-line;border:1px solid rgba(255,255,255,0.05)';
  preview.textContent = summaryText;
  groupBanner.appendChild(preview);

  box.appendChild(groupBanner);

  // ‚îÄ‚îÄ Individual transfers with personal WA reminders
  if (transfers.length) {
    const body = document.createElement('div');
    body.style.cssText = 'overflow-y:auto;flex:1;padding:14px 16px 32px';

    const indivLabel = document.createElement('div');
    indivLabel.style.cssText = 'font-size:0.88rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--gold-dim);margin-bottom:10px';
    indivLabel.textContent = 'Individual Reminders';
    body.appendChild(indivLabel);

    transfers.forEach(t => {
      const fromPhone = getPhone(t.from);
      const toPhone = getPhone(t.to);
      
      // Personal message for the payer
      const payerMsg = 'Hi ' + t.from + '! Reminder: you owe ' + t.to + ' $' + t.amount.toFixed(2) + ' from ' + gameName + '. ‚ô†';
      // Personal message for the receiver  
      const receiverMsg = 'Hi ' + t.to + '! Just a reminder ‚Äî ' + t.from + ' owes you $' + t.amount.toFixed(2) + ' from ' + gameName + '. ‚ô†';

      const row = document.createElement('div');
      row.style.cssText = 'background:var(--bg2);border:1px solid var(--border);border-left:3px solid rgba(231,76,60,0.5);border-radius:10px;padding:11px 13px;margin-bottom:8px';

      // Transfer line
      const transferLine = document.createElement('div');
      transferLine.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:9px';
      transferLine.innerHTML = 
        '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">' +
          '<div style="width:30px;height:30px;border-radius:50%;background:rgba(231,76,60,0.2);border:1px solid rgba(231,76,60,0.3);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:#ff9a8b">' + esc(inits(t.from)) + '</div>' +
          '<div style="font-size:0.9rem;color:var(--muted);max-width:42px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center">' + esc(t.from) + '</div>' +
        '</div>' +
        '<div style="flex:1;text-align:center">' +
          '<div style="font-size:0.88rem;color:var(--muted)">pays</div>' +
          '<div style="font-size:1.05rem;font-weight:700;color:var(--cream)">$' + t.amount.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">' +
          '<div style="width:30px;height:30px;border-radius:50%;background:rgba(46,204,113,0.15);border:1px solid rgba(46,204,113,0.25);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:#7fffb0">' + esc(inits(t.to)) + '</div>' +
          '<div style="font-size:0.9rem;color:var(--muted);max-width:42px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center">' + esc(t.to) + '</div>' +
        '</div>';
      row.appendChild(transferLine);

      // WA buttons row
      const waBtns = document.createElement('div');
      waBtns.style.cssText = 'display:flex;gap:6px';

      if (fromPhone) {
        const btn = document.createElement('a');
        btn.href = waUrl(fromPhone, payerMsg);
        btn.target = '_blank';
        btn.style.cssText = 'flex:1;display:flex;align-items:center;justify-content:center;gap:5px;background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.25);color:#ff9a8b;padding:7px;border-radius:7px;font-size:0.82rem;font-weight:700;text-decoration:none';
        btn.innerHTML = 'üí¨ Remind ' + esc(t.from);
        btn.addEventListener('click', () => setTimeout(() => overlay.remove(), 400));
        waBtns.appendChild(btn);
      }
      if (toPhone) {
        const btn = document.createElement('a');
        btn.href = waUrl(toPhone, receiverMsg);
        btn.target = '_blank';
        btn.style.cssText = 'flex:1;display:flex;align-items:center;justify-content:center;gap:5px;background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);color:#7fffb0;padding:7px;border-radius:7px;font-size:0.82rem;font-weight:700;text-decoration:none';
        btn.innerHTML = 'üí¨ Notify ' + esc(t.to);
        btn.addEventListener('click', () => setTimeout(() => overlay.remove(), 400));
        waBtns.appendChild(btn);
      }
      if (!fromPhone && !toPhone) {
        const noPhone = document.createElement('div');
        noPhone.style.cssText = 'font-size:0.8rem;color:var(--muted);text-align:center;padding:4px';
        noPhone.textContent = 'Add phone numbers in Contacts to send reminders';
        waBtns.appendChild(noPhone);
      }

      row.appendChild(waBtns);
      body.appendChild(row);
    });

    box.appendChild(body);
  } else {
    const allGood = document.createElement('div');
    allGood.style.cssText = 'padding:24px 16px;text-align:center;font-size:0.82rem;color:var(--green)';
    allGood.textContent = '‚úì Everyone is already square!';
    box.appendChild(allGood);
  }

  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function openPublish() {
  const players = Object.values(state.players || {}).filter(p => p && p.name && pBuyin(p) > 0).map(p => ({ name: p.name, net: pNet(p), bi: pBuyin(p), co: pCash(p) })).sort((a, b) => b.net - a.net);
  if (!players.length) { toast('No players yet'); return; }
  showConfirmModal(
    '‚ô† Publish Results?',
    'This will generate a shareable results page with final standings and settlements.',
    'Publish',
    () => _doOpenPublish(players)
  );
}
function _doOpenPublish(players) {
  recordStats();
  const transfers = calcSettlements(players);
  const payload = { game: state.game, players, transfers, publishedAt: Date.now() };
  const enc = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  const url = (typeof APP_URL !== 'undefined' ? APP_URL : location.origin + location.pathname) + '#results=' + enc;
  // Standings preview
  const standingsHtml = players.map(p => `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(201,168,76,0.06)"><span style="color:var(--cream2);font-size:0.9rem">${esc(p.name)}</span><span class="${nc(p.net)}" style="font-weight:700;font-size:0.82rem">${fmtNet(p.net)}</span></div>`).join('');
  // Settlements preview
  const settleHtml = transfers.length
    ? '<div style="font-size:0.88rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold-dim);margin:10px 0 6px;padding-top:8px;border-top:1px solid var(--border)">üí∏ Settlements</div>' +
      transfers.map(t => `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(201,168,76,0.04)"><span style="color:var(--red);font-size:0.9rem">${esc(t.from)}</span><span style="color:var(--muted);font-size:0.88rem">‚Üí $${t.amount.toFixed(2)} ‚Üí</span><span style="color:var(--green);font-size:0.9rem">${esc(t.to)}</span></div>`).join('')
    : '<div style="font-size:0.88rem;color:var(--green);padding:6px 0;margin-top:6px;border-top:1px solid var(--border)">‚úì No transfers needed</div>';
  document.getElementById('publishPreview').innerHTML = standingsHtml + settleHtml;
  document.getElementById('publishUrl').value = url;

  // Build the WhatsApp group message: standings + settlements + link
  const waLines = [];
  waLines.push('*' + (state.game ? state.game.name : 'Poker Night') + '* - Final Results');
  waLines.push('');
  players.forEach(p => waLines.push((p.net >= 0 ? '+' : '') + '$' + p.net.toFixed(2) + '  ' + p.name));
  if (transfers.length) {
    waLines.push('');
    waLines.push('*Settle Up*');
    transfers.forEach(t => waLines.push(t.from + ' pays ' + t.to + ' $' + t.amount.toFixed(2)));
  }
  waLines.push('');
  waLines.push('Full results: ' + url);
  const waGroupMsg = waLines.join('\n');
  const _shareBtn = document.getElementById('waGroupShareBtn');
  _shareBtn.dataset.shareText = waGroupMsg;
  _shareBtn.dataset.shareUrl = document.getElementById('publishUrl').value;

  document.getElementById('publishSheet').classList.add('show');
}

function closePublish() {
  document.getElementById('publishSheet').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER INSTALL + NOTIFICATION SETUP SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildInstallLink() {
  const base = typeof APP_URL !== 'undefined' ? APP_URL : location.origin;
  return cloudGroupId ? base + '#install=' + cloudGroupId : null;
}

async function showInstallScreen(groupId) {
  // Store the group ID so push subscriptions work
  if (groupId && !cloudGroupId) {
    cloudGroupId = groupId;
    localStorage.setItem('cloudGroupId', groupId);
  }

  const isIOS     = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isAndroid = /android/i.test(navigator.userAgent);
  // iOS 16.4+ supports push only when running as installed PWA (standalone)
  const isStandaloneNow = window.navigator.standalone === true
    || window.matchMedia('(display-mode: standalone)').matches;
  const hasPush = 'PushManager' in window && 'serviceWorker' in navigator;
  const notifPerm = 'Notification' in window ? Notification.permission : 'unsupported';

  showScreen('liveScreen');

  // Fetch group name to personalise screen
  let groupName = 'The Table';
  try {
    const grp = await apiGetGroup(groupId);
    if (grp.groupName) groupName = grp.groupName;
    if (cloudMyName && grp.subscribers && grp.subscribers[cloudMyName.toLowerCase()]) {
      // Already registered ‚Äî show status screen instead
      showAlreadyRegistered(groupId, groupName, grp);
      return;
    }
  } catch(e) {}

  renderInstallScreen(groupId, groupName, isIOS, isAndroid, isStandaloneNow, hasPush, notifPerm);
}

function renderInstallScreen(groupId, groupName, isIOS, isAndroid, isStandaloneNow, hasPush, notifPerm) {
  const step3Done = !!(cloudMyName && localStorage.getItem('registeredGroup_' + groupId));
  const notifGranted = notifPerm === 'granted';
  const notifDenied  = notifPerm === 'denied';
  const isStandalone = isStandaloneNow;

  document.getElementById('liveInner').innerHTML = `
    <div style="display:flex;flex-direction:column;min-height:100vh;padding:24px 20px 40px;max-width:480px;margin:0 auto">
      <div style="text-align:center;margin-bottom:28px">
        <div style="font-size:2.5rem;margin-bottom:10px">‚ô†</div>
        <div style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--cream)">${esc(groupName)}</div>
        <div style="font-size:0.88rem;color:var(--muted);margin-top:5px">Enter your name so the host knows you're in</div>
      </div>

      ${step3Done ? `
        <!-- Already registered -->
        <div style="padding:20px;background:rgba(46,204,113,0.06);border:1px solid rgba(46,204,113,0.3);border-radius:14px;text-align:center;margin-bottom:20px">
          <div style="font-size:1.5rem;margin-bottom:8px">‚úÖ</div>
          <div style="font-size:1rem;font-weight:700;color:var(--green);margin-bottom:4px">You're in, ${esc(cloudMyName)}!</div>
          <div style="font-size:0.88rem;color:var(--muted)">The host can see you're interested. You'll get notified when the game starts.</div>
        </div>
        <button id="reRegisterBtn" style="width:100%;padding:12px;background:none;border:1px solid var(--border);color:var(--muted);border-radius:10px;font-size:0.88rem;cursor:pointer;margin-bottom:20px">
          Use a different name
        </button>
      ` : `
        <!-- Name entry -->
        <div style="margin-bottom:20px">
          <input id="installName" type="text" value="${esc(cloudMyName || '')}"
            placeholder="Your name (e.g. Alex)"
            style="width:100%;box-sizing:border-box;padding:14px;background:rgba(0,0,0,0.3);border:1px solid var(--border2);border-radius:10px;color:var(--cream);font-family:'DM Sans',sans-serif;font-size:1rem;margin-bottom:12px;outline:none">
          <button id="installRegisterBtn" style="width:100%;padding:15px;background:linear-gradient(135deg,var(--gold),#8a5c20);color:#000;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer">
            ‚úÖ I'm In
          </button>
          <div id="installStatus" style="font-size:0.85rem;color:var(--muted);text-align:center;margin-top:8px;min-height:18px"></div>
        </div>
      `}

      <!-- Notifications section -->
      <div style="padding:16px;background:var(--bg2);border:1px solid ${notifGranted ? 'rgba(46,204,113,0.3)' : 'var(--border)'};border-radius:12px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:${notifGranted ? '0' : '12px'}">
          <span style="font-size:1.2rem">${notifGranted ? 'üîî' : 'üîï'}</span>
          <div>
            <div style="font-size:0.9rem;font-weight:700;color:${notifGranted ? 'var(--green)' : 'var(--cream)'}">
              ${notifGranted ? 'Notifications On ‚úì' : 'Enable Notifications'}
            </div>
            <div style="font-size:0.78rem;color:var(--muted)">
              ${notifGranted ? "You'll be alerted when the game starts" : 'Optional ‚Äî get alerted when a game is scheduled'}
            </div>
          </div>
        </div>
        ${notifGranted ? '' : (notifDenied
          ? `<div style="font-size:0.85rem;color:var(--gold);line-height:1.7;padding:10px;background:rgba(201,168,76,0.08);border-radius:8px">
               ‚ö†Ô∏è Notifications are blocked. To fix:<br>
               <b>1.</b> Go to iPhone <b>Settings ‚Üí scroll to The Table ‚Üí Notifications ‚Üí Allow</b><br>
               <b>2.</b> Then open the app from your Home Screen icon
             </div>`
          : (!isStandalone
            ? `<div style="font-size:0.85rem;color:var(--cream2);line-height:1.7;padding:10px;background:rgba(255,255,255,0.04);border-radius:8px">
                 Open <b>The Table</b> from your <b>Home Screen icon</b> to enable notifications ‚Äî iOS requires this.
               </div>`
            : `<button id="enableNotifBtn" style="width:100%;padding:12px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);color:#fff;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer">
                 üîî Enable Notifications
               </button>
               <div id="notifBtnStatus" style="font-size:0.82rem;color:var(--muted);text-align:center;margin-top:6px;min-height:16px"></div>`)
        )}
      </div>

      <!-- Install section (only if not standalone) -->
      ${!isStandalone ? `
        <div style="padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
          <div style="font-size:0.85rem;font-weight:700;color:var(--cream);margin-bottom:8px">üì≤ Add to Home Screen <span style="font-size:0.75rem;color:var(--muted);font-weight:400">(optional)</span></div>
          <div style="font-size:0.82rem;color:var(--cream2);line-height:1.8">
            Tap <b style="color:var(--gold)">Share ‚¨ÜÔ∏è</b> ‚Üí <b style="color:var(--gold)">"Add to Home Screen"</b> ‚Üí <b style="color:var(--gold)">Add</b>
          </div>
        </div>
      ` : ''}

      <div style="text-align:center;margin-top:8px">
        <a href="./" style="font-size:0.82rem;color:var(--muted);text-decoration:none">‚Üê Back to home</a>
      </div>
    </div>`;

  // Wire name register button
  const regBtn = document.getElementById('installRegisterBtn');
  if (regBtn) {
    regBtn.addEventListener('click', async () => {
      const name = (document.getElementById('installName').value || '').trim();
      const statusEl = document.getElementById('installStatus');
      if (!name) { statusEl.textContent = 'Please enter your name'; return; }
      regBtn.textContent = 'Saving‚Ä¶'; regBtn.disabled = true;
      cloudMyName = name;
      localStorage.setItem('cloudMyName', name);
      try {
        const swReg = await registerServiceWorker();
        if (swReg) await new Promise(r => setTimeout(r, 600));
        const sub = await subscribePushToGroup(name, null).catch(() => null);
        localStorage.setItem('registeredGroup_' + groupId, name);
        statusEl.textContent = '‚úì Saved!';
        await new Promise(r => setTimeout(r, 400));
        const nowStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        const nowPerm = ('Notification' in window) ? Notification.permission : 'denied';
        renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, nowPerm);
      } catch(e) {
        statusEl.textContent = '‚úó Error: ' + e.message;
        regBtn.textContent = 'Try Again'; regBtn.disabled = false;
      }
    });
  }

  // Wire re-register button
  const reRegBtn = document.getElementById('reRegisterBtn');
  if (reRegBtn) {
    reRegBtn.addEventListener('click', () => {
      localStorage.removeItem('registeredGroup_' + groupId);
      const nowStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      const nowPerm = ('Notification' in window) ? Notification.permission : 'denied';
      renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, nowPerm);
    });
  }

  // Wire enable notifications button
  const enableBtn = document.getElementById('enableNotifBtn');
  if (enableBtn) {
    enableBtn.addEventListener('click', async () => {
      enableBtn.textContent = 'Requesting‚Ä¶'; enableBtn.disabled = true;
      const statusEl = document.getElementById('notifBtnStatus');
      try {
        await registerServiceWorker();
        const perm = await Promise.race([
          Notification.requestPermission(),
          new Promise(res => setTimeout(() => res('timeout'), 10000))
        ]);
        const nowStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        if (perm === 'granted') {
          if (cloudMyName && cloudGroupId) subscribePushToGroup(cloudMyName, null).catch(() => {});
          renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, 'granted');
        } else if (perm === 'timeout') {
          if (statusEl) statusEl.textContent = 'Timed out ‚Äî try again';
          enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
        } else {
          renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, perm);
        }
      } catch(e) {
        if (statusEl) statusEl.textContent = 'Error: ' + e.message;
        enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
      }
    });
  }
}


async function showInstallScreen(groupId) {
  // Store the group ID so push subscriptions work
  if (groupId && !cloudGroupId) {
    cloudGroupId = groupId;
    localStorage.setItem('cloudGroupId', groupId);
  }

  const isIOS     = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isAndroid = /android/i.test(navigator.userAgent);
  // iOS 16.4+ supports push only when running as installed PWA (standalone)
  const isStandaloneNow = window.navigator.standalone === true
    || window.matchMedia('(display-mode: standalone)').matches;
  const hasPush = 'PushManager' in window && 'serviceWorker' in navigator;
  const notifPerm = 'Notification' in window ? Notification.permission : 'unsupported';

  showScreen('liveScreen');

  // Fetch group name to personalise screen
  let groupName = 'The Table';
  try {
    const grp = await apiGetGroup(groupId);
    if (grp.groupName) groupName = grp.groupName;
    if (cloudMyName && grp.subscribers && grp.subscribers[cloudMyName.toLowerCase()]) {
      // Already registered ‚Äî show status screen instead
      showAlreadyRegistered(groupId, groupName, grp);
      return;
    }
  } catch(e) {}

  renderInstallScreen(groupId, groupName, isIOS, isAndroid, isStandaloneNow, hasPush, notifPerm);
}

function renderInstallScreen(groupId, groupName, isIOS, isAndroid, isStandalone, hasPush, notifPerm) {
  const alreadyInstalled = isStandalone;
  const step1Done = alreadyInstalled;
  const step2Done = notifPerm === 'granted';
  // step3 is only done if we have BOTH a name AND a confirmed group registration
  const step3Done = !!(cloudMyName && localStorage.getItem('registeredGroup_' + groupId));

  const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|opios/i.test(navigator.userAgent);

  const installInstructions = isIOS
    ? (isSafari
      ? `<div style="font-size:0.9rem;color:var(--cream2);line-height:2;margin:10px 0">
           1. Tap the <b style="color:var(--gold)">Share ‚¨ÜÔ∏è</b> button at the bottom of Safari<br>
           2. Tap <b style="color:var(--gold)">"Add to Home Screen"</b><br>
           3. Tap <b style="color:var(--gold)">"Add"</b><br>
           4. Open ‚ô† The Table from your <b>Home Screen icon</b> ‚Äî notifications can only be enabled from there
         </div>`
      : `<div style="font-size:0.88rem;color:var(--gold);line-height:1.7;margin:10px 0;padding:10px;background:rgba(201,168,76,0.08);border-radius:8px">
           ‚ö†Ô∏è You must use <b>Safari</b> to install on iPhone.<br>Copy this link and open it in Safari.
         </div>`)
    : isAndroid
    ? `<div style="font-size:0.9rem;color:var(--cream2);line-height:2;margin:10px 0">
         1. Tap the <b style="color:var(--gold)">‚ãÆ menu</b> in Chrome (top right)<br>
         2. Tap <b style="color:var(--gold)">"Add to Home screen"</b><br>
         3. Tap <b style="color:var(--gold)">"Install"</b><br>
         4. Open the app from your home screen
       </div>`
    : `<div style="font-size:0.9rem;color:var(--cream2);line-height:1.9;margin:10px 0">
         Use your browser menu ‚Üí "Add to Home Screen" or "Install App"
       </div>`;

  document.getElementById('liveInner').innerHTML = `
    <div style="display:flex;flex-direction:column;min-height:100vh;padding:24px 20px 40px;max-width:480px;margin:0 auto">
      <div style="text-align:center;margin-bottom:24px">
        <div style="font-size:2.5rem;margin-bottom:8px">‚ô†</div>
        <div style="font-size:1.1rem;font-weight:700;color:var(--cream)">Join ${esc(groupName)}</div>
        <div style="font-size:0.88rem;color:var(--muted);margin-top:4px">Set up once ‚Äî get notified for every game</div>
      </div>

      <!-- STEP 1 -->
      <div style="margin-bottom:14px;padding:16px;background:var(--bg2);border:1px solid ${step1Done ? 'rgba(46,204,113,0.4)' : 'rgba(201,168,76,0.2)'};border-radius:12px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:${step1Done ? '0' : '12px'}">
          <div style="width:28px;height:28px;border-radius:50%;background:${step1Done ? 'rgba(46,204,113,0.2)' : 'rgba(201,168,76,0.15)'};display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:${step1Done ? 'var(--green)' : 'var(--gold)'};flex-shrink:0">${step1Done ? '‚úì' : '1'}</div>
          <div>
            <div style="font-size:0.88rem;font-weight:700;color:var(--cream)">${step1Done ? 'App Installed ‚úì' : 'Install the App'}</div>
            <div style="font-size:0.82rem;color:var(--muted)">${step1Done ? 'Running as installed PWA' : 'Add to your home screen'}</div>
          </div>
        </div>
        ${step1Done ? '' : installInstructions}
      </div>

      <!-- STEP 2 -->
      <div style="margin-bottom:14px;padding:16px;background:var(--bg2);border:1px solid ${step2Done ? 'rgba(46,204,113,0.4)' : 'rgba(201,168,76,0.2)'};border-radius:12px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:${step2Done ? '0' : '12px'}">
          <div style="width:28px;height:28px;border-radius:50%;background:${step2Done ? 'rgba(46,204,113,0.2)' : 'rgba(201,168,76,0.15)'};display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:${step2Done ? 'var(--green)' : 'var(--gold)'};flex-shrink:0">${step2Done ? '‚úì' : '2'}</div>
          <div>
            <div style="font-size:0.88rem;font-weight:700;color:var(--cream)">${step2Done ? 'Notifications Enabled ‚úì' : 'Enable Notifications'}</div>
            <div style="font-size:0.82rem;color:var(--muted)">${step2Done ? "You'll be alerted for every game" : 'Required to receive game alerts'}</div>
          </div>
        </div>
        ${step2Done ? '' : (notifPerm === 'denied'
          ? `<div style="font-size:0.88rem;color:var(--gold);line-height:1.7;padding:8px;background:rgba(201,168,76,0.08);border-radius:8px">
               ‚ö†Ô∏è Notifications are blocked.<br>
               ${isIOS
                 ? 'Go to: iPhone Settings ‚Üí Scroll down to The Table ‚Üí Notifications ‚Üí Allow Notifications. Then open The Table from your Home Screen icon.'
                 : 'Go to: Settings ‚Üí App Notifications ‚Üí Allow'}
             </div>`
          : `<button id="enableNotifBtn" style="width:100%;padding:12px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);color:#fff;border:none;border-radius:9px;font-family:DM Sans,sans-serif;font-size:0.84rem;font-weight:700;cursor:pointer">üîî Enable Notifications</button>
             <div id="notifBtnStatus" style="font-size:0.85rem;color:var(--muted);text-align:center;margin-top:6px;min-height:16px"></div>`
        )}
      </div>

      <!-- STEP 3 -->
      <div style="margin-bottom:24px;padding:16px;background:var(--bg2);border:1px solid ${step3Done ? 'rgba(46,204,113,0.4)' : 'rgba(201,168,76,0.2)'};border-radius:12px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:${step3Done ? '0' : '12px'}">
          <div style="width:28px;height:28px;border-radius:50%;background:${step3Done ? 'rgba(46,204,113,0.2)' : 'rgba(201,168,76,0.15)'};display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:${step3Done ? 'var(--green)' : 'var(--gold)'};flex-shrink:0">${step3Done ? '‚úì' : '3'}</div>
          <div>
            <div style="font-size:0.88rem;font-weight:700;color:var(--cream)">${step3Done ? 'Registered as ' + esc(cloudMyName) + ' ‚úì' : 'Enter Your Name'}</div>
            <div style="font-size:0.82rem;color:var(--muted)">${step3Done ? 'Notifications active ‚Äî all done!' : 'So the host knows who you are'}</div>
          </div>
        </div>
        ${step3Done ? `
          <button id="reRegisterBtn" style="margin-top:8px;background:none;border:1px solid var(--border);color:var(--muted);padding:7px 14px;border-radius:8px;font-family:DM Sans,sans-serif;font-size:0.85rem;cursor:pointer;display:block">Register as different name</button>
        ` : `
          <input id="installName" type="text" value="${esc(cloudMyName || '')}"
            placeholder="Your name (e.g. Jeemit)"
            style="width:100%;box-sizing:border-box;padding:12px;background:rgba(0,0,0,0.3);border:1px solid var(--border2);border-radius:8px;color:var(--cream);font-family:DM Sans,sans-serif;font-size:0.88rem;margin-bottom:10px">
          <button id="installRegisterBtn" style="width:100%;padding:13px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);color:#fff;border:none;border-radius:9px;font-family:DM Sans,sans-serif;font-size:0.84rem;font-weight:700;cursor:pointer">
            ‚úÖ Register &amp; Activate Notifications
          </button>
          <div id="installStatus" style="font-size:0.85rem;color:var(--muted);text-align:center;margin-top:8px;min-height:18px"></div>
        `}
      </div>

      ${(step1Done && step2Done && step3Done) ? `
        <div style="text-align:center;padding:20px;background:rgba(46,204,113,0.06);border:1px solid rgba(46,204,113,0.2);border-radius:12px;margin-bottom:16px">
          <div style="font-size:1.5rem;margin-bottom:8px">üéâ</div>
          <div style="font-size:0.88rem;font-weight:700;color:var(--green);margin-bottom:4px">All set, ${esc(cloudMyName)}!</div>
          <div style="font-size:0.88rem;color:var(--muted);margin-bottom:14px">You'll get a notification whenever a game is scheduled.</div>
          <button id="testPushBtn" style="padding:10px 22px;background:rgba(46,204,113,0.15);border:1px solid rgba(46,204,113,0.35);color:var(--green);border-radius:9px;font-family:DM Sans,sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer">üîî Send me a test notification</button>
          <div id="testPushStatus" style="font-size:0.85rem;color:var(--muted);margin-top:8px;min-height:16px"></div>
        </div>
      ` : ''}

      <div style="text-align:center;margin-top:8px">
        <a href="/" style="font-size:0.82rem;color:var(--muted);text-decoration:none">‚Üê Back to home</a>
      </div>
    </div>`;

  // Wire Enable Notifications button
  const enableBtn = document.getElementById('enableNotifBtn');
  if (enableBtn) {
    enableBtn.addEventListener('click', async () => {
      enableBtn.textContent = 'Requesting‚Ä¶'; enableBtn.disabled = true;
      const statusEl = document.getElementById('notifBtnStatus');
      const nowStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      // iOS requires standalone for push notifications
      if (isIOS && !nowStandalone) {
        enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
        if (statusEl) statusEl.innerHTML = '‚ö†Ô∏è Open <b>The Table</b> from your Home Screen icon first, then tap the invite link again inside the app.';
        return;
      }
      try {
        await registerServiceWorker();
        const perm = await Promise.race([
          Notification.requestPermission(),
          new Promise(res => setTimeout(() => res('timeout'), 10000))
        ]);
        if (perm === 'granted') {
          renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, 'granted');
        } else if (perm === 'timeout') {
          if (statusEl) statusEl.textContent = 'Timed out ‚Äî please try again';
          enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
        } else {
          if (statusEl) statusEl.textContent = 'Permission denied ‚Äî enable in device Settings';
          enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
        }
      } catch(e) {
        if (statusEl) statusEl.textContent = 'Error: ' + e.message;
        enableBtn.textContent = 'üîî Enable Notifications'; enableBtn.disabled = false;
      }
    });
  }

  // Wire Register button
  const regBtn = document.getElementById('installRegisterBtn');
  if (regBtn) {
    regBtn.addEventListener('click', async () => {
      const name = (document.getElementById('installName').value || '').trim();
      const statusEl = document.getElementById('installStatus');
      if (!name) { statusEl.textContent = 'Please enter your name'; return; }
      // Re-read permission live ‚Äî it may have been granted since render
      const currentPerm = ('Notification' in window) ? Notification.permission : 'denied';
      // Proceed regardless ‚Äî push subscription will be skipped if permission not granted
      regBtn.textContent = 'Registering‚Ä¶'; regBtn.disabled = true;
      statusEl.textContent = 'Setting up service worker‚Ä¶';
      try {
        cloudMyName = name;
        localStorage.setItem('cloudMyName', name);

        // Ensure SW is registered and active
        const swReg = await registerServiceWorker();
        statusEl.textContent = 'Subscribing to notifications‚Ä¶';
        // Give SW a moment to activate (blob SW doesn't support .ready)
        if (swReg) await new Promise(r => setTimeout(r, 800));
        // Try push subscription but don't block registration on it
        const sub = await subscribePushToGroup(name, null).catch(() => null);
        // Always mark as registered ‚Äî name is saved regardless of push
        localStorage.setItem('registeredGroup_' + groupId, name);
        statusEl.textContent = sub ? '‚úì Registered with notifications!' : '‚úì Registered! (No push ‚Äî notifications may be off)';
        await new Promise(r => setTimeout(r, 600));
        const nowStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        const nowPerm = ('Notification' in window) ? Notification.permission : 'denied';
        renderInstallScreen(groupId, groupName, isIOS, isAndroid, nowStandalone, hasPush, nowPerm);
      } catch(e) {
        statusEl.textContent = '‚úó Error: ' + e.message;
        regBtn.textContent = 'Try Again'; regBtn.disabled = false;
      }
    });
  }

  // Wire re-register button
  const reRegBtn = document.getElementById('reRegisterBtn');
  if (reRegBtn) {
    reRegBtn.addEventListener('click', () => {
      localStorage.removeItem('registeredGroup_' + groupId);
      cloudMyName = null; localStorage.removeItem('cloudMyName');
      renderInstallScreen(groupId, groupName, isIOS, isAndroid, isStandalone, hasPush, notifPerm);
    });
  }

  // Wire test notification button
  const testBtn = document.getElementById('testPushBtn');
  if (testBtn) {
    testBtn.addEventListener('click', async () => {
      testBtn.textContent = 'Sending‚Ä¶'; testBtn.disabled = true;
      const statusEl = document.getElementById('testPushStatus');
      try {
        const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) return null;
        const sub = await reg.pushManager.getSubscription();
        if (!sub) throw new Error('No subscription ‚Äî try re-registering');
        const res = await fetchWithTimeout(WORKER_URL + '/push-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscription: sub.toJSON() })
        });
        const data = await res.json();
        if (data.ok) {
          statusEl.textContent = '‚úì Check your notifications now!';
          testBtn.textContent = '‚úì Sent!';
        } else {
          throw new Error(data.error || 'Server returned error');
        }
      } catch(e) {
        statusEl.textContent = '‚úó ' + e.message;
        testBtn.textContent = 'üîî Try again'; testBtn.disabled = false;
      }
    });
  }
}
function showAlreadyRegistered(groupId, groupName, grp) {
  showScreen('liveScreen');
  renderPlayerDashboard(groupId, groupName, grp);
  // Poll for updates every 5 seconds
  if (window._playerDashboardPoll) clearInterval(window._playerDashboardPoll);
  window._playerDashboardPoll = setInterval(async () => {
    try {
      const updated = await apiGetGroup(groupId);
      renderPlayerDashboard(groupId, groupName, updated);
    } catch(e) {}
  }, 5000);
}

async function renderPlayerDashboard(groupId, groupName, grp) {
  const inner = document.getElementById('liveInner');
  if (!inner) return;

  const subscribers = grp.subscribers || {};
  const playerNames = Object.keys(subscribers);
  const activeCode  = grp.activeGameCode;
  const notifOk     = 'Notification' in window && Notification.permission === 'granted';

  // Try to get game details if there's an active game
  let game = null;
  if (activeCode) {
    try {
      const gData = await apiGetGame(activeCode);
      game = gData && gData.game ? gData.game : gData;
    } catch(e) {}
  }

  const dateStr = game && game.gameDate
    ? new Date(game.gameDate).toLocaleDateString(undefined, { weekday:'long', day:'numeric', month:'long' })
    : null;

  const myNameLower = (cloudMyName || '').toLowerCase();
  const iAmIn = playerNames.some(n => n.toLowerCase() === myNameLower);

  inner.innerHTML = `
    <div style="max-width:480px;margin:0 auto;padding:20px 16px 60px">

      <!-- Header -->
      <div style="text-align:center;padding:24px 0 20px">
        <div style="font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--gold)">${esc(groupName)}</div>
        <div style="font-size:0.82rem;color:var(--muted);margin-top:4px;letter-spacing:1px;text-transform:uppercase">Player View</div>
      </div>

      <!-- Your status card -->
      <div style="background:linear-gradient(135deg,#0d2010,#132a14);border:1px solid rgba(201,168,76,0.25);border-radius:14px;padding:18px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--rail2));display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;color:var(--cream);flex-shrink:0">
            ${esc((cloudMyName||'?').slice(0,2).toUpperCase())}
          </div>
          <div style="flex:1">
            <div style="font-size:1rem;font-weight:700;color:var(--cream)">${esc(cloudMyName || 'You')}</div>
            <div style="font-size:0.78rem;color:${iAmIn ? 'var(--green)' : 'var(--muted)'};margin-top:2px">
              ${iAmIn ? '‚úì Registered for this group' : '‚ö† Not yet registered'}
            </div>
          </div>
          <div style="font-size:1.3rem">${notifOk ? 'üîî' : 'üîï'}</div>
        </div>
        ${!notifOk ? `
          <div style="margin-top:12px;padding:10px;background:rgba(201,168,76,0.08);border-radius:8px;font-size:0.8rem;color:var(--gold);line-height:1.6">
            ${('Notification' in window && Notification.permission === 'denied')
              ? '‚ö†Ô∏è Notifications blocked ‚Äî go to <b>iPhone Settings ‚Üí The Table ‚Üí Notifications ‚Üí Allow</b>'
              : 'üîî <button id="playerEnableNotif" style="background:none;border:none;color:var(--gold);font-size:0.8rem;font-weight:700;cursor:pointer;text-decoration:underline;padding:0">Tap to enable notifications</button>'}
          </div>` : ''}
      </div>

      <!-- Active game card -->
      ${activeCode ? `
        <div style="background:var(--bg2);border:1px solid rgba(46,204,113,0.25);border-radius:14px;padding:18px;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
            <div style="width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite"></div>
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--green);font-weight:700">
              ${game && game.ended ? 'Last Game' : 'Game Scheduled'}
            </div>
          </div>
          <div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--cream);margin-bottom:10px">
            ${esc(game && game.name ? game.name : groupName + ' Poker')}
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            ${dateStr ? `<div style="display:flex;gap:8px;font-size:0.88rem"><span style="color:var(--muted);min-width:20px">üìÖ</span><span style="color:var(--cream2)">${dateStr}</span></div>` : ''}
            ${game && game.location ? `<div style="display:flex;gap:8px;font-size:0.88rem"><span style="color:var(--muted);min-width:20px">üìç</span><span style="color:var(--cream2)">${esc(game.location)}</span></div>` : ''}
            ${game && game.stakes ? `<div style="display:flex;gap:8px;font-size:0.88rem"><span style="color:var(--muted);min-width:20px">üí∞</span><span style="color:var(--cream2)">${esc(game.stakes)}</span></div>` : ''}
          </div>
        </div>
      ` : `
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:16px;text-align:center">
          <div style="font-size:1.5rem;margin-bottom:8px">‚è≥</div>
          <div style="font-size:0.9rem;color:var(--muted)">No game scheduled yet.<br>You'll get notified when one is set up.</div>
        </div>
      `}

      <!-- RSVP list -->
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:0.78rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold-dim);font-weight:600">Who's In</div>
          <div style="font-size:0.82rem;color:var(--muted)">${playerNames.length} registered</div>
        </div>
        ${playerNames.length === 0
          ? `<div style="padding:18px;text-align:center;font-size:0.88rem;color:var(--muted)">No players registered yet</div>`
          : playerNames.map(name => {
              const isMe = name.toLowerCase() === myNameLower;
              const initials = name.slice(0,2).toUpperCase();
              return `<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(201,168,76,0.06)">
                <div style="width:34px;height:34px;border-radius:50%;background:${isMe ? 'linear-gradient(135deg,var(--gold-dim),#8a5c20)' : 'linear-gradient(135deg,#1a3a1a,#0d2010)'};display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--cream);flex-shrink:0">${initials}</div>
                <div style="flex:1;font-size:0.92rem;color:${isMe ? 'var(--gold)' : 'var(--cream)'};font-weight:${isMe ? '700' : '400'}">${esc(name)}${isMe ? ' (you)' : ''}</div>
                <div style="font-size:0.75rem;color:var(--green)">‚úì</div>
              </div>`;
            }).join('')
        }
      </div>

      <!-- Actions -->
      <div style="display:flex;flex-direction:column;gap:10px">
        <button id="playerChangeNameBtn" style="padding:12px;background:none;border:1px solid var(--border);color:var(--muted);border-radius:10px;font-size:0.88rem;cursor:pointer">
          Change my name
        </button>
        <a href="./" style="display:block;text-align:center;padding:12px;font-size:0.82rem;color:var(--muted);text-decoration:none">‚Üê Back to home</a>
      </div>
    </div>`;

  // Wire enable notif button
  const enBtn = document.getElementById('playerEnableNotif');
  if (enBtn) {
    enBtn.addEventListener('click', async () => {
      const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      if (!isStandalone) { toast('Open from your Home Screen icon first'); return; }
      try {
        await registerServiceWorker();
        const perm = await Notification.requestPermission();
        if (perm === 'granted') {
          if (cloudMyName && cloudGroupId) subscribePushToGroup(cloudMyName, null).catch(() => {});
          renderPlayerDashboard(groupId, groupName, grp);
          toast('‚úì Notifications enabled!');
        }
      } catch(e) {}
    });
  }

  // Wire change name button
  const changeBtn = document.getElementById('playerChangeNameBtn');
  if (changeBtn) {
    changeBtn.addEventListener('click', () => {
      if (window._playerDashboardPoll) { clearInterval(window._playerDashboardPoll); window._playerDashboardPoll = null; }
      localStorage.removeItem('registeredGroup_' + groupId);
      const nowStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      const nowPerm = ('Notification' in window) ? Notification.permission : 'denied';
      renderInstallScreen(groupId, groupName,
        /iphone|ipad|ipod/i.test(navigator.userAgent),
        /android/i.test(navigator.userAgent),
        nowStandalone, 'PushManager' in window, nowPerm);
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkLiveView() {
  // Handle #install=GROUPID ‚Äî player install + notification setup screen
  if (location.hash.startsWith('#install=')) {
    const groupId = location.hash.slice(9);
    if (groupId) { showInstallScreen(groupId); return true; }
  }
  // Handle #rsvp=CODE ‚Äî fallback for direct game links (no group)
  if (location.hash.startsWith('#rsvp=')) {
    const hashVal = location.hash.slice(6);
    const parts = hashVal.split('&');
    const code = (parts[0] || '').toUpperCase().replace(/[^A-Z0-9]/g,'');
    // Pick up groupId if embedded (legacy links)
    parts.slice(1).forEach(p => {
      if (p.startsWith('g=') && !cloudGroupId) {
        cloudGroupId = p.slice(2);
        localStorage.setItem('cloudGroupId', cloudGroupId);
      }
    });
    if (code.length === 6) { showSeatClaimScreen(code); return true; }
  }
  // Handle #group=ID ‚Äî permanent group link (auto-joins active game)
  if (location.hash.startsWith('#group=')) {
    const groupId = location.hash.slice(7);
    if (groupId) { autoJoinGroup(groupId); return true; }
  }
  // Handle #join=CODE ‚Äî auto-join the game directly
  if (location.hash.startsWith('#join=')) {
    const code = location.hash.slice(6).toUpperCase();
    if (code && code.length === 6) {
      autoJoinGame(code);
      return true;
    }
  }
  if (!location.hash.startsWith('#live=')) return false;
  showScreen('liveScreen');
  if (cloudGameCode) {
    syncFromCloud();
    setInterval(syncFromCloud, 4000);
  } else {
    loadState();
  }
  renderLive();
  setInterval(() => { if (!cloudGameCode) loadState(); renderLive(); }, 4000);
  return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAT CLAIM (pre-game RSVP)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showSeatClaimScreen(code) {
  showScreen('liveScreen');
  document.getElementById('liveInner').innerHTML =
    '<div style="text-align:center;padding:80px 32px;color:var(--cream2)">‚è≥ Loading...</div>';
  try {
    const data = await apiGetGame(code);
    state = data.state;
    setCloudRole('player', code, cloudMyName || '');
    renderSeatClaimScreen(code, data);
  } catch(e) {
    document.getElementById('liveInner').innerHTML =
      '<div style="text-align:center;padding:60px 32px;color:var(--red)">Game not found.<br><br><a href="/" style="color:var(--gold)">‚Üê Home</a></div>';
  }
}

function buildSeatGrid(players, seatCount, selectedSid) {
  // Build just the seat grid HTML ‚Äî called on initial render and on poll updates
  let html = '';
  for (let i = 1; i <= seatCount; i++) {
    const sid = 'seat' + i;
    const p = players[sid];
    const taken = p && p.name;
    const isMe = taken && cloudMyName && p.name.toLowerCase() === cloudMyName.toLowerCase();
    const isSelected = sid === selectedSid;
    html += `<div data-sid="${sid}" class="rsvp-seat${taken?' taken':''}${isMe?' mine':''}"
      style="padding:10px 6px;border-radius:10px;
        border:2px solid ${isSelected?'var(--gold)':isMe?'var(--gold)':taken?'rgba(201,168,76,0.15)':'rgba(201,168,76,0.3)'};
        background:${isSelected?'rgba(201,168,76,0.07)':isMe?'rgba(201,168,76,0.1)':taken?'rgba(0,0,0,0.3)':'rgba(30,107,42,0.08)'};
        outline:${isSelected?'2px solid var(--gold)':'none'};
        text-align:center;cursor:${taken?'default':'pointer'};transition:all 0.15s">
      <div style="font-size:1.1rem;margin-bottom:3px">${isMe?'‚úÖ':taken?'üîí':'+'}</div>
      <div style="font-size:0.82rem;color:${taken?'var(--muted)':'var(--gold)'};font-weight:700">${taken?esc(p.name):'Seat '+i}</div>
    </div>`;
  }
  return html;
}

function renderSeatClaimScreen(code, data) {
  const g = data.state.game || {};
  const seatCount = g.seats || 10;
  const players = data.state.players || {};
  const dateStr = g.gameDate
    ? new Date(g.gameDate).toLocaleDateString(undefined,{weekday:'long',day:'numeric',month:'long'}) +
      ' at ' + new Date(g.gameDate).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})
    : 'Tonight';

  // ‚îÄ‚îÄ INITIAL RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('liveInner').innerHTML = `
    <div style="max-width:440px;margin:0 auto;padding:24px 16px 48px">
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-size:2.5rem;margin-bottom:10px">‚ô†</div>
        <div style="font-size:1.3rem;font-weight:700;color:var(--cream);margin-bottom:4px">${esc(g.name||'Poker Night')}</div>
        ${g.stakes?`<div style="font-size:0.88rem;color:var(--gold);margin-bottom:4px">${esc(g.stakes)}</div>`:''}
        <div style="font-size:0.88rem;color:var(--muted);margin-bottom:2px">üìÖ ${dateStr}</div>
        ${g.location?`<div style="font-size:0.88rem;color:var(--muted)">üìç ${esc(g.location)}</div>`:''}
      </div>
      <div style="font-size:0.9rem;text-transform:uppercase;letter-spacing:2px;color:var(--gold-dim);margin-bottom:10px;text-align:center">
        Tap an empty seat to claim it
      </div>
      <div id="rsvpGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px">
        ${buildSeatGrid(players, seatCount, null)}
      </div>
      <div id="rsvpNameWrap" style="display:none;margin-bottom:12px">
        <div id="rsvpSelectedLabel" style="font-size:0.82rem;color:var(--gold);text-align:center;margin-bottom:6px;font-weight:700"></div>
        <input id="rsvpName" type="text" placeholder="Your name"
          style="width:100%;padding:13px;background:#0d1a0f;border:1px solid var(--border);border-radius:8px;
                 color:var(--cream);font-family:DM Sans,sans-serif;font-size:0.9rem;box-sizing:border-box;text-align:center"
          autocomplete="off" value="${esc(cloudMyName||'')}">
      </div>
      <button id="rsvpConfirmBtn" style="width:100%;padding:14px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);
        color:#fff;border:none;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.9rem;font-weight:700;
        cursor:pointer;display:none;margin-bottom:10px">
        Claim Seat
      </button>
      <div id="rsvpStatus" style="text-align:center;font-size:0.88rem;color:var(--muted);min-height:18px;margin-bottom:12px"></div>
      <button id="rsvpWatchBtn" style="width:100%;padding:12px;background:none;border:1px solid var(--border);
        color:var(--muted);border-radius:8px;font-family:DM Sans,sans-serif;font-size:0.9rem;cursor:pointer">
        Just Watch (no seat)
      </button>
    </div>`;

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Kept outside the poll so it survives re-renders of the grid
  let selectedSid = null;
  let pollActive = true;

  function attachSeatHandlers() {
    document.querySelectorAll('#rsvpGrid .rsvp-seat:not(.taken)').forEach(el => {
      el.addEventListener('click', () => {
        selectedSid = el.dataset.sid;
        // Highlight selected seat without re-rendering
        document.querySelectorAll('#rsvpGrid .rsvp-seat').forEach(s => {
          s.style.outline = '';
          s.style.borderColor = s.classList.contains('mine') ? 'var(--gold)' :
            s.classList.contains('taken') ? 'rgba(201,168,76,0.15)' : 'rgba(201,168,76,0.3)';
          s.style.background = s.classList.contains('mine') ? 'rgba(201,168,76,0.1)' :
            s.classList.contains('taken') ? 'rgba(0,0,0,0.3)' : 'rgba(30,107,42,0.08)';
        });
        el.style.outline = '2px solid var(--gold)';
        el.style.borderColor = 'var(--gold)';
        el.style.background = 'rgba(201,168,76,0.07)';
        // Show name input ‚Äî keep any text already typed
        document.getElementById('rsvpNameWrap').style.display = 'block';
        document.getElementById('rsvpConfirmBtn').style.display = 'block';
        const num = selectedSid.replace('seat','');
        document.getElementById('rsvpSelectedLabel').textContent = 'Seat ' + num + ' selected';
        document.getElementById('rsvpStatus').textContent = '';
        setTimeout(() => {
          const inp = document.getElementById('rsvpName');
          if (inp && !inp.value) inp.focus();
        }, 80);
      });
    });
  }
  attachSeatHandlers();

  // ‚îÄ‚îÄ CONFIRM CLAIM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('rsvpConfirmBtn').addEventListener('click', async () => {
    const name = (document.getElementById('rsvpName').value || '').trim();
    if (!name) { document.getElementById('rsvpStatus').textContent = 'Enter your name first'; return; }
    if (!selectedSid) { document.getElementById('rsvpStatus').textContent = 'Pick a seat first'; return; }
    const btn = document.getElementById('rsvpConfirmBtn');
    btn.textContent = 'Claiming...'; btn.disabled = true;
    pollActive = false; // stop polling while we claim
    document.getElementById('rsvpStatus').textContent = '';

    cloudMyName = name;
    localStorage.setItem('cloudMyName', name);
    setCloudRole('player', code, name);

    try {
      const fresh = await apiGetGame(code);
      state = fresh.state;
      const sid = selectedSid;
      // Race condition check ‚Äî seat may have been taken
      if (state.players[sid] && state.players[sid].name) {
        document.getElementById('rsvpStatus').textContent = 'That seat was just taken ‚Äî pick another!';
        btn.textContent = 'Claim Seat'; btn.disabled = false;
        selectedSid = null;
        document.getElementById('rsvpNameWrap').style.display = 'none';
        document.getElementById('rsvpConfirmBtn').style.display = 'none';
        // Refresh grid only to show updated taken seats
        document.getElementById('rsvpGrid').innerHTML = buildSeatGrid(state.players, g.seats || 10, null);
        attachSeatHandlers();
        pollActive = true;
        return;
      }
      // ‚îÄ‚îÄ Ask for notification permission FIRST (must be in direct user gesture) ‚îÄ‚îÄ
      // Wrap in timeout ‚Äî on some iOS/Safari versions requestPermission can hang indefinitely
      let pushOk = false;
      try {
        if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
          if (Notification.permission === 'granted') {
            pushOk = true;
          } else if (Notification.permission !== 'denied') {
            // Race against a 6-second timeout ‚Äî if the dialog doesn't resolve, move on
            const permResult = await Promise.race([
              Notification.requestPermission(),
              new Promise(res => setTimeout(() => res('timeout'), 6000))
            ]);
            pushOk = (permResult === 'granted');
          }
        }
      } catch(permErr) {
        // Permission API not supported or threw ‚Äî skip push, continue with seat claim
        pushOk = false;
      }

      // ‚îÄ‚îÄ Write seat claim to cloud ‚îÄ‚îÄ
      state.players[sid] = { name, transactions: [], rsvp: true };
      await apiSetState(code, state);

      // ‚îÄ‚îÄ Register push subscription now that permission is sorted ‚îÄ‚îÄ
      if (pushOk) {
        try {
          await registerServiceWorker();
          await new Promise(r => setTimeout(r, 800));
          await subscribePushToGroup(name, code);
        } catch(subErr) {
          // Push subscription failed ‚Äî not fatal, seat is already claimed
        }
      }

      // ‚îÄ‚îÄ Waiting screen ‚Äî polls every 3s, auto-transitions when host starts ‚îÄ‚îÄ
      const notifLine = pushOk
        ? '<div style="font-size:0.88rem;color:var(--green);margin-bottom:6px">üîî Notifications enabled ‚Äî you\'ll be alerted when the game starts</div>'
        : '<div style="font-size:0.88rem;color:var(--gold);margin-bottom:6px">‚ö†Ô∏è Notifications blocked ‚Äî keep this page open to know when the game starts</div>';
      document.getElementById('liveInner').innerHTML = `
        <div id="rsvpWaitScreen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;
              min-height:80vh;padding:32px;text-align:center">
          <div style="font-size:3rem;margin-bottom:16px">‚úÖ</div>
          <div style="font-size:1.2rem;font-weight:700;color:var(--cream);margin-bottom:8px">You're in, ${esc(name)}!</div>
          <div style="font-size:0.9rem;color:var(--muted);margin-bottom:6px">Seat ${sid.replace('seat','')} reserved</div>
          ${notifLine}
          <div id="rsvpWaitStatus" style="font-size:0.85rem;color:var(--muted);margin-bottom:24px">‚è≥ Waiting for the host to start the game‚Ä¶</div>
          <div style="font-size:0.8rem;color:var(--gold-dim);margin-bottom:24px">This page will open the table automatically when the game goes live</div>
          <button id="cancelRsvpBtn" style="background:none;border:1px solid rgba(231,76,60,0.4);color:rgba(231,76,60,0.8);
            padding:10px 24px;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.88rem;cursor:pointer">
            ‚úï Cancel my reservation
          </button>
        </div>`;

      // Wire cancel RSVP button
      const cancelBtn = document.getElementById('cancelRsvpBtn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', async () => {
          if (!confirm('Cancel your reservation for Seat ' + sid.replace('seat','') + '?')) return;
          cancelBtn.textContent = 'Cancelling‚Ä¶'; cancelBtn.disabled = true;
          try {
            const fresh = await apiGetGame(code);
            const s = fresh.state;
            if (s.players[sid] && s.players[sid].name === name) {
              delete s.players[sid];
              await apiSetState(code, s);
            }
            // Show cancelled screen
            document.getElementById('liveInner').innerHTML = `
              <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;
                    min-height:80vh;padding:32px;text-align:center">
                <div style="font-size:3rem;margin-bottom:16px">üëã</div>
                <div style="font-size:1rem;font-weight:700;color:var(--cream);margin-bottom:8px">Reservation cancelled</div>
                <div style="font-size:0.9rem;color:var(--muted);margin-bottom:24px">Seat ${sid.replace('seat','')} is now free for someone else</div>
                <button onclick="location.reload()" style="padding:11px 28px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);
                  color:#fff;border:none;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer">
                  Claim a different seat
                </button>
              </div>`;
          } catch(e) {
            cancelBtn.textContent = 'Error ‚Äî try again'; cancelBtn.disabled = false;
          }
        });
      }

      // Poll every 3s ‚Äî when lobbyActive flips false, go straight to live table
      const waitPollId = setInterval(async () => {
        if (!document.getElementById('rsvpWaitScreen')) { clearInterval(waitPollId); return; }
        try {
          const check = await apiGetGame(code);
          if (!check.state || !check.state.game) {
            // Game deleted or cancelled
            clearInterval(waitPollId);
            handleGameEndedForPlayer('This game was cancelled by the host.');
            return;
          }
          if (check.state.game.ended) {
            clearInterval(waitPollId);
            handleGameEndedForPlayer((check.state.game.name || 'The game') + ' was cancelled.');
            return;
          }
          if (!check.state.game.lobbyActive) {
            clearInterval(waitPollId);
            // Game has started ‚Äî transition to live read-only view
            state = check.state;
            localStorage.setItem(SK, JSON.stringify(state));
            setCloudRole('player', code, name);
            startSyncPolling();
            enterReadOnlyGame();
          }
        } catch(e) {
          // 404 = game gone
          clearInterval(waitPollId);
          handleGameEndedForPlayer('This game is no longer available.');
        }
      }, 3000);
    } catch(e) {
      document.getElementById('rsvpStatus').textContent = 'Error ‚Äî please try again';
      btn.textContent = 'Claim Seat'; btn.disabled = false;
      pollActive = true;
    }
  });

  // ‚îÄ‚îÄ JUST WATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('rsvpWatchBtn').addEventListener('click', () => {
    pollActive = false;
    setCloudRole('player', code, cloudMyName || '');
    startSyncPolling();
    enterReadOnlyGame();
  });

  // ‚îÄ‚îÄ BACKGROUND POLL ‚Äî only updates the seat grid, never wipes the name input ‚îÄ‚îÄ
  const pollId = setInterval(async () => {
    if (!pollActive || !document.getElementById('rsvpGrid')) {
      clearInterval(pollId);
      return;
    }
    try {
      const fresh = await apiGetGame(code);
      state = fresh.state;
      // Only re-render the grid ‚Äî leave name input and buttons untouched
      const gridEl = document.getElementById('rsvpGrid');
      if (gridEl) {
        gridEl.innerHTML = buildSeatGrid(state.players, g.seats || 10, selectedSid);
        attachSeatHandlers();
        // Re-apply selection highlight if user had one
        if (selectedSid) {
          const sel = gridEl.querySelector(`[data-sid="${selectedSid}"]`);
          if (sel && !sel.classList.contains('taken')) {
            sel.style.outline = '2px solid var(--gold)';
            sel.style.borderColor = 'var(--gold)';
            sel.style.background = 'rgba(201,168,76,0.07)';
          } else if (sel && sel.classList.contains('taken')) {
            // Someone else took this seat while player was typing ‚Äî alert them
            document.getElementById('rsvpStatus').textContent = 'Seat ' + selectedSid.replace('seat','') + ' was just taken ‚Äî pick another!';
            selectedSid = null;
            document.getElementById('rsvpNameWrap').style.display = 'none';
            document.getElementById('rsvpConfirmBtn').style.display = 'none';
          }
        }
      }
    } catch(e) {}
  }, 4000);
}

async function autoJoinGroup(groupId) {
  showScreen('liveScreen');
  document.getElementById('liveInner').innerHTML = '<div style="text-align:center;padding:80px 32px;color:var(--cream2);font-size:0.9rem">‚è≥ Finding game...</div>';
  try {
    const grp = await apiGetGroup(groupId);
    // Always store the group ID on this device ‚Äî enables push subscriptions
    setGroupData(groupId, grp.groupName);

    if (!grp.activeGameCode) {
      // Group exists but host hasn't created a game yet
      document.getElementById('liveInner').innerHTML = `
        <div style="text-align:center;padding:80px 32px">
          <div style="font-size:2rem;margin-bottom:16px">‚ô†</div>
          <div style="font-size:1rem;font-weight:700;color:var(--cream);margin-bottom:8px">${esc(grp.groupName)}</div>
          <div style="font-size:0.9rem;color:var(--muted);line-height:1.7">No game scheduled yet.<br>The host will send an invite when it's time.</div>
        </div>`;
      return;
    }

    const data = await apiGetGame(grp.activeGameCode);
    state = data.state;
    localStorage.setItem(SK, JSON.stringify(state));

    // Detect whether the game is still in lobby (RSVP) phase or already live
    const inLobby = state.game && state.game.lobbyActive;

    if (inLobby) {
      // Game is in pre-game lobby ‚Äî show seat claim screen
      // Make sure cloudGroupId is set so push subscription works
      if (!cloudGroupId) {
        cloudGroupId = groupId;
        localStorage.setItem('cloudGroupId', groupId);
      }
      showSeatClaimScreen(grp.activeGameCode);
    } else {
      // Game is live ‚Äî join as spectator/player
      setCloudRole('player', grp.activeGameCode, cloudMyName || '');
      if (cloudMyName) {
        startSyncPolling();
        enterReadOnlyGame();
        // Re-subscribe push to this game
        if ('serviceWorker' in navigator && Notification.permission === 'granted') {
          await registerServiceWorker();
          await new Promise(r => setTimeout(r, 800));
          await subscribePushToGroup(cloudMyName, grp.activeGameCode);
          toast('Rejoined ' + grp.groupName + ' ‚Äî notifications active!');
        } else {
          toast('Rejoined ' + grp.groupName);
        }
      } else {
        showJoinPrompt(grp.activeGameCode, data.gameName, groupId);
      }
    }
  } catch(e) {
    document.getElementById('liveInner').innerHTML = '<div style="text-align:center;padding:60px 32px"><div style="font-size:0.9rem;color:var(--red);margin-bottom:16px">Group not found.</div><a href="/" style="color:var(--gold);font-size:0.82rem">‚Üê Go home</a></div>';
  }
}

async function autoJoinGame(code) {
  // Show a loading screen while we fetch game data
  showScreen('liveScreen');
  document.getElementById('liveInner').innerHTML = '<div style="text-align:center;padding:60px;color:var(--cream2);font-size:0.9rem">Joining game...</div>';
  
  try {
    const data = await apiGetGame(code);
    state = data.state;
    localStorage.setItem(SK, JSON.stringify(state));
    setCloudRole('player', code, cloudMyName || '');
    
    // Show join screen to get their name + enable notifications
    showJoinPrompt(code, data.gameName);
  } catch(e) {
    document.getElementById('liveInner').innerHTML = '<div style="text-align:center;padding:60px;color:var(--red);font-size:0.9rem">Game not found.<br><br><a href="/" style="color:var(--gold)">Go to home</a></div>';
  }
}

function showJoinPrompt(code, gameName, groupId) {
  showScreen('liveScreen');
  document.getElementById('liveInner').innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:32px;text-align:center">
      <div style="font-size:2rem;margin-bottom:16px">‚ô†</div>
      <div style="font-size:1.2rem;font-weight:700;color:var(--cream);margin-bottom:6px">${esc(gameName)}</div>
      <div style="font-size:0.88rem;color:var(--muted);margin-bottom:28px">You have been invited to join this game</div>
      <div style="width:100%;max-width:320px">
        <input id="autoJoinName" type="text" placeholder="Your name" style="width:100%;padding:14px;background:#0d1a0f;border:1px solid var(--border);border-radius:10px;color:var(--cream);font-family:DM Sans,sans-serif;font-size:0.88rem;margin-bottom:12px;box-sizing:border-box;text-align:center" autocomplete="off">
        <button id="autoJoinBtn" style="width:100%;padding:14px;background:linear-gradient(135deg,#1e6b2a,#0f4a1a);color:#fff;border:none;border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;margin-bottom:10px">Join Game &amp; Enable Notifications</button>
        <button id="autoJoinSkipBtn" style="width:100%;padding:12px;background:none;border:1px solid var(--border);color:var(--muted);border-radius:10px;font-family:DM Sans,sans-serif;font-size:0.9rem;cursor:pointer">Just Watch (no notifications)</button>
      </div>
      <div id="autoJoinStatus" style="margin-top:14px;font-size:0.85rem;color:var(--muted)"></div>
    </div>`;

  document.getElementById('autoJoinBtn').addEventListener('click', async () => {
    const name = (document.getElementById('autoJoinName').value || '').trim();
    if (!name) { document.getElementById('autoJoinStatus').textContent = 'Enter your name'; return; }
    const btn = document.getElementById('autoJoinBtn');
    btn.textContent = 'Joining...'; btn.disabled = true;
    document.getElementById('autoJoinStatus').textContent = '';

    setCloudRole('player', code, name);
    cloudMyName = name;
    localStorage.setItem('cloudMyName', name);

    // Request notifications
    let notifMsg = '';
    if ('Notification' in window && 'serviceWorker' in navigator) {
      try {
        const perm = await Notification.requestPermission();
        if (perm === 'granted') {
          await registerServiceWorker();
          await new Promise(r => setTimeout(r, 1000));
          const sub = await subscribePush(name, code);
          notifMsg = sub ? 'Notifications enabled!' : 'Notifications unavailable';
        } else {
          notifMsg = 'Notifications declined';
        }
      } catch(e) { notifMsg = 'Notifications unavailable on this device'; }
    } else {
      notifMsg = 'Notifications not supported on this browser';
    }

    startSyncPolling();
    enterReadOnlyGame();
    if (notifMsg) toast(notifMsg);
  });

  document.getElementById('autoJoinSkipBtn').addEventListener('click', () => {
    startSyncPolling();
    enterReadOnlyGame();
  });
}
function renderLive() {
  const players = Object.values(state.players).filter(p => p && p.name && pBuyin(p) > 0).map(p => ({ name: p.name, net: pNet(p), bi: pBuyin(p), co: pCash(p) })).sort((a, b) => b.net - a.net);
  const g = state.game || { name: 'Poker Night', stakes: '' };
  const totalIn = players.reduce((a, p) => a + p.bi, 0);
  const inBank = totalIn - players.reduce((a, p) => a + p.co, 0);
  const active = players.filter(p => p.co === 0).length;
  document.getElementById('liveInner').innerHTML = `
    <div class="lv-hdr">
      <div class="lv-title">${esc(g.name)}</div>
      ${g.stakes ? `<div class="lv-sub">${esc(g.stakes)}</div>` : ''}
      <div class="lv-live"><span class="lv-dot"></span>Live</div>
    </div>
    <div class="lv-bank">
      <div class="lv-bk"><div class="lv-bk-l">Total In</div><div class="lv-bk-v">$${totalIn.toFixed(0)}</div></div>
      <div class="lv-bk"><div class="lv-bk-l">In Bank</div><div class="lv-bk-v ${inBank >= 0 ? 'ok' : 'no'}">$${inBank.toFixed(0)}</div></div>
      <div class="lv-bk"><div class="lv-bk-l">Active</div><div class="lv-bk-v">${active}</div></div>
    </div>
    <div class="lv-rows">
      ${players.length ? players.map(p => `<div class="lv-row ${p.net > 0 ? 'win' : p.net < 0 ? 'lose' : ''}"><div class="lv-av">${esc(inits(p.name))}</div><div class="lv-nm">${esc(p.name)}</div><div class="lv-pl ${nc(p.net)}">${fmtNet(p.net)}</div></div>`).join('') : '<div style="text-align:center;color:var(--muted);padding:40px;font-size:0.8rem">No players yet</div>'}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESULTS VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkResultsView() {
  if (!location.hash.startsWith('#results=')) return false;
  showScreen('resultsScreen');
  try {
    const payload = JSON.parse(decodeURIComponent(escape(atob(location.hash.slice(9)))));
    renderResults(payload);
  } catch(e) {
    document.getElementById('resultsInner').innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted)">Invalid results link</div>';
  }
  return true;
}
function renderResults(payload) {
  const { game, players, transfers: savedTransfers, publishedAt } = payload;
  const g = game || { name: 'Poker Night', stakes: '' };
  const date = new Date(publishedAt).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const totalIn = players.reduce((a, p) => a + p.bi, 0);
  // Use saved transfers or recalculate
  const transfers = savedTransfers && savedTransfers.length >= 0 ? savedTransfers : calcSettlements(players);

  const settleRows = transfers.length
    ? transfers.map(t => `
        <div class="settle-row">
          <div class="settle-from"><div class="settle-av">${esc(inits(t.from))}</div><div class="settle-nm">${esc(t.from)}</div></div>
          <div class="settle-arrow"><div class="settle-arrow-line">‚Üí</div><div class="settle-amount">$${t.amount.toFixed(2)}</div></div>
          <div class="settle-to"><div class="settle-av">${esc(inits(t.to))}</div><div class="settle-nm">${esc(t.to)}</div></div>
        </div>`).join('')
    : '<div class="settle-clean">‚úì Everyone is square ‚Äî no transfers needed!</div>';

  document.getElementById('resultsInner').innerHTML = `
    <div class="res-hero">
      <h1>${esc(g.name)}</h1><div class="res-sub">Final Results</div>
      <div class="res-meta">
        <div class="rm"><div class="rm-v">${players.length}</div><div class="rm-l">Players</div></div>
        <div class="rm"><div class="rm-v">$${totalIn.toFixed(0)}</div><div class="rm-l">Total In</div></div>
        ${g.stakes ? `<div class="rm"><div class="rm-v" style="font-size:0.82rem">${esc(g.stakes)}</div><div class="rm-l">Stakes</div></div>` : ''}
      </div>
    </div>
    <div class="res-rows">
      <div class="res-sec">Full Standings</div>
      ${players.map((p, i) => `<div class="res-row"><div class="rr-rank">${i+1}</div><div class="rr-av">${esc(inits(p.name))}</div><div class="rr-nm"><div class="rr-n">${esc(p.name)}</div><div class="rr-d">In: $${p.bi.toFixed(0)} ¬∑ Out: $${p.co.toFixed(0)}</div></div><div class="rr-pl ${nc(p.net)}">${fmtNet(p.net)}</div></div>`).join('')}
    </div>
    <div class="settle-section">
      <div class="settle-hdr">
        <div class="settle-hdr-icon">üí∏</div>
        <div class="settle-title">Settlements ‚Äî ${transfers.length} transfer${transfers.length !== 1 ? 's' : ''} needed</div>
      </div>
      ${settleRows}
    </div>
    <div class="res-footer"><div style="font-size:1rem;margin-bottom:4px">‚ô† ‚ô• ‚ô£ ‚ô¶</div><div>${esc(date)}</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD CONTACT OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEED DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seedData() {
  // Migrate data from old localStorage keys (previous app versions)
  const OLD_STATS = 'pokerPlayerStats', OLD_HIST = 'pokerPlayerHistory', OLD_PHONES = 'pokerPhoneBook';
  try {
    const oldStats = localStorage.getItem(OLD_STATS);
    if (oldStats) {
      const parsed = JSON.parse(oldStats);
      // Convert old format {name:{games,net}} to new format
      const newStats = getStats();
      Object.values(parsed).forEach(p => {
        if (p && p.name) {
          const k = p.name.toLowerCase();
          if (!newStats[k]) newStats[k] = { name: p.name, games: p.games || 0, net: p.net || 0, lastSeen: p.lastSeen || Date.now() };
        }
      });
      saveStats(newStats);
    }
    const oldHist = localStorage.getItem(OLD_HIST);
    if (oldHist) {
      const parsed = JSON.parse(oldHist);
      const existing = getHistory();
      const merged = [...new Set([...parsed, ...existing])];
      localStorage.setItem(HIST_K, JSON.stringify(merged));
    }
    const oldPhones = localStorage.getItem(OLD_PHONES);
    if (oldPhones) {
      const parsed = JSON.parse(oldPhones);
      const existing = getPhones();
      // Old format: {name: {name, phone}} ‚Äî same as new
      Object.values(parsed).forEach(c => {
        if (c && c.name) {
          const k = c.name.toLowerCase();
          if (!existing[k]) existing[k] = { name: c.name, phone: c.phone || '' };
        }
      });
      savePhones(existing);
    }
  } catch(e) {}

  // Always seed historical player data on every load ‚Äî safe/idempotent, never removes real data
  const historical = [
    {name:'Jay',     games:2, net:805},
    {name:'Prakash', games:2, net:310},
    {name:'Jeemit',  games:2, net:250},
    {name:'Dhronal', games:2, net:215},
    {name:'Hardik',  games:2, net:50},
    {name:'Dhruv',   games:1, net:10},
    {name:'Kalpesh', games:2, net:-225},
    {name:'Prashant',games:2, net:-275},
    {name:'Tapan',   games:2, net:-365},
    {name:'Ronak',   games:2, net:-725},
  ];
  try {
    const stats = getStats();
    historical.forEach(p => {
      const k = p.name.toLowerCase();
      if (!stats[k]) stats[k] = { name: p.name, games: p.games, net: p.net, lastSeen: Date.now() - 86400000 };
    });
    saveStats(stats);
    const existing = getHistory();
    const merged = [...new Set([...existing, ...historical.map(p => p.name)])];
    localStorage.setItem(HIST_K, JSON.stringify(merged));
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START GAME FROM LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doStartGame() {
  closeLobby(); // also stops lobbyPollInterval

  // Seat all RSVP players with a default buy-in transaction
  const defaultBuyin = (state.game && state.game.defaultBuyin) || 25;
  let seated = 0;
  Object.keys(state.players).forEach(sid => {
    const p = state.players[sid];
    if (p && p.name && p.rsvp) {
      // Add the default buy-in if they don't already have any transactions
      if (!p.transactions || p.transactions.length === 0) {
        p.transactions = [{ type: 'buyin', amount: defaultBuyin, ts: Date.now() }];
        seated++;
      }
      p.rsvp = false; // mark as fully seated
    }
  });

  // Clear lobby flag
  if (state.game) state.game.lobbyActive = false;
  saveState();

  // Push final state to cloud
  if (cloudGameCode && cloudGameCode !== 'LOCAL') {
    await apiSetState(cloudGameCode, state).catch(() => {});
    // Notify all group/game subscribers
    if (cloudGroupId) {
      const gName = state.game ? state.game.name : 'Poker Night';
      const body = seated > 0
        ? gName + ' is live! ' + seated + ' player' + (seated>1?'s have':' has') + ' been seated with $' + defaultBuyin + '. Join the table!'
        : gName + ' is now live! Come join the table!';
      apiGroupNotify(cloudGroupId, '‚ô† Game is Live!', body, 'all').catch(() => {});
    } else {
      const gName = state.game ? state.game.name : 'Poker Night';
      apiNotify(cloudGameCode, '‚ô† Game is Live!', gName + ' has started!', 'all').catch(() => {});
    }
  }

  openGame();
  if (seated > 0) {
    toast('Game live! ' + seated + ' player' + (seated>1?'s':'') + ' seated with $' + defaultBuyin);
  } else {
    toast('Game is live!');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIRE UP ALL EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', function() {

  // Click-outside handlers for overlays (can't use onclick= for these)
  document.getElementById('newGameOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('newGameOverlay')) closeNewGame();
  });
  document.getElementById('assignOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('assignOverlay')) closeAssign();
  });
  document.getElementById('lbSheet').addEventListener('click', e => {
    if (e.target === document.getElementById('lbSheet')) closeLbSheet();
  });
  document.getElementById('shareSheet').addEventListener('click', e => {
    if (e.target === document.getElementById('shareSheet')) closeShare();
  });
  document.getElementById('publishSheet').addEventListener('click', e => {
    if (e.target === document.getElementById('publishSheet')) closePublish();
  });
  document.getElementById('pwOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('pwOverlay'))
      document.getElementById('pwOverlay').classList.remove('show');
  });

  // Input Enter key handlers
  document.getElementById('ngName').addEventListener('keydown', e => {
    if (e.key === 'Enter') confirmNewGame();
  });
  document.getElementById('assignName').addEventListener('keydown', e => {
    if (e.key === 'Enter') confirmAssign();
  });
  document.getElementById('assignName').addEventListener('input', () => {
    const n = document.getElementById('assignName').value.trim();
    if (!n) return;
    const ph = getPhone(n);
    if (ph) document.getElementById('assignPhone').value = ph.startsWith('61') ? '0' + ph.slice(2) : ph;
  });
  document.getElementById('pwInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('pwConfirmBtn').click();
  });

  // Notification enable button (async handler)
  document.getElementById('notifEnableBtn').addEventListener('click', async () => {
    document.getElementById('notifBanner').style.display = 'none';
    await registerServiceWorker();
    const perm = await Notification.requestPermission();
    if (perm === 'granted' && cloudGameCode && cloudMyName) {
      await new Promise(r => setTimeout(r, 800));
      await subscribePush(cloudMyName, cloudGameCode);
      toast('Notifications enabled!');
    }
  });

  seedData();
  loadState();

  // Restore cloud session if we had one
  if (cloudRole && cloudGameCode) {
    startSyncPolling();
    maybeShowNotifBanner();
    setTimeout(initAutoSchedule, 3000);
    if (!checkResultsView() && !checkLiveView()) {
      try {
        if (cloudRole === 'host') {
          if (!state.game) { renderHome(); }
          else if (state.game.lobbyActive) {
            const inviteLink = buildGroupLink('rsvp');
            openLobby(state.game.name, state.game.stakes, state.game.gameDate,
              state.game.location, state.game.seats, inviteLink, cloudGameCode);
          } else {
            openGame();
          }
        } else if (cloudRole === 'player') {
          enterReadOnlyGame();
          syncFromCloud();
        } else {
          renderHome();
        }
      } catch(err) {
        console.error('Startup error:', err);
        renderHome();
      }
    }
  } else if (!checkResultsView() && !checkLiveView()) {
    if (state.game && !state.game.ended) {
      setCloudRole('host', state.game.code || 'LOCAL', 'Host');
      openGame();
    } else {
      renderHome();
    }
  }
});</script>
</body>
</html>
